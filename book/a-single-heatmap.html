<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 A Single Heatmap | ComplexHeatmap Complete Reference</title>
  <meta name="description" content="Complex heatmaps are efficient to visualize associations between different sources of data sets and reveal potential patterns. Here the ComplexHeatmap R package provides a highly flexible way to arrange multiple heatmaps and supports various annotation graphics. This book is the complete reference to ComplexHeatmap pacakge." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 A Single Heatmap | ComplexHeatmap Complete Reference" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://jokergoo.github.io/ComplexHeatmap-reference/book" />
  <meta property="og:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/bookcomplexheatmap-cover.jpg" />
  <meta property="og:description" content="Complex heatmaps are efficient to visualize associations between different sources of data sets and reveal potential patterns. Here the ComplexHeatmap R package provides a highly flexible way to arrange multiple heatmaps and supports various annotation graphics. This book is the complete reference to ComplexHeatmap pacakge." />
  <meta name="github-repo" content="jokergoo/ComplexHeatmap-reference" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 A Single Heatmap | ComplexHeatmap Complete Reference" />
  
  <meta name="twitter:description" content="Complex heatmaps are efficient to visualize associations between different sources of data sets and reveal potential patterns. Here the ComplexHeatmap R package provides a highly flexible way to arrange multiple heatmaps and supports various annotation graphics. This book is the complete reference to ComplexHeatmap pacakge." />
  <meta name="twitter:image" content="https://jokergoo.github.io/ComplexHeatmap-reference/bookcomplexheatmap-cover.jpg" />

<meta name="author" content="Zuguang Gu" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="heatmap-annotations.html"/>
<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">ComplexHeatmap Complete Reference</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#general-design"><i class="fa fa-check"></i><b>1.1</b> General design</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#a-brief-description-of-following-chapters"><i class="fa fa-check"></i><b>1.2</b> A brief description of following chapters</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html"><i class="fa fa-check"></i><b>2</b> A Single Heatmap</a>
<ul>
<li class="chapter" data-level="2.1" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#colors"><i class="fa fa-check"></i><b>2.1</b> Colors</a></li>
<li class="chapter" data-level="2.2" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#heatmap-titles"><i class="fa fa-check"></i><b>2.2</b> Titles</a></li>
<li class="chapter" data-level="2.3" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#clustering"><i class="fa fa-check"></i><b>2.3</b> Clustering</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#distance-methods"><i class="fa fa-check"></i><b>2.3.1</b> Distance methods</a></li>
<li class="chapter" data-level="2.3.2" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#clustering-methods"><i class="fa fa-check"></i><b>2.3.2</b> Clustering methods</a></li>
<li class="chapter" data-level="2.3.3" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#render-dendrograms"><i class="fa fa-check"></i><b>2.3.3</b> Render dendrograms</a></li>
<li class="chapter" data-level="2.3.4" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#reorder-dendrograms"><i class="fa fa-check"></i><b>2.3.4</b> Reorder dendrograms</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#row-and_column_orders"><i class="fa fa-check"></i><b>2.4</b> Set row and column orders</a></li>
<li class="chapter" data-level="2.5" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#heatmap-seriation"><i class="fa fa-check"></i><b>2.5</b> Seriation</a></li>
<li class="chapter" data-level="2.6" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#dimension-names"><i class="fa fa-check"></i><b>2.6</b> Dimension names</a></li>
<li class="chapter" data-level="2.7" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#heatmap-split"><i class="fa fa-check"></i><b>2.7</b> Heatmap split</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#split-by-kmeans-clustering"><i class="fa fa-check"></i><b>2.7.1</b> Split by k-means clustering</a></li>
<li class="chapter" data-level="2.7.2" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#split-by-categorical-variables"><i class="fa fa-check"></i><b>2.7.2</b> Split by categorical variables</a></li>
<li class="chapter" data-level="2.7.3" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#spilt-by-dendrogram"><i class="fa fa-check"></i><b>2.7.3</b> Split by dendrogram</a></li>
<li class="chapter" data-level="2.7.4" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#order-of-slices"><i class="fa fa-check"></i><b>2.7.4</b> Order of slices</a></li>
<li class="chapter" data-level="2.7.5" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#titles-for-splitting"><i class="fa fa-check"></i><b>2.7.5</b> Titles for splitting</a></li>
<li class="chapter" data-level="2.7.6" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#graphic-parameters-for-splitting"><i class="fa fa-check"></i><b>2.7.6</b> Graphic parameters for splitting</a></li>
<li class="chapter" data-level="2.7.7" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#gaps-between-slices"><i class="fa fa-check"></i><b>2.7.7</b> Gaps between slices</a></li>
<li class="chapter" data-level="2.7.8" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#split-heatmap-annotations"><i class="fa fa-check"></i><b>2.7.8</b> Split heatmap annotations</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#heatmap-as-raster-image"><i class="fa fa-check"></i><b>2.8</b> Heatmap as raster image</a></li>
<li class="chapter" data-level="2.9" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#customize-the-heatmap-body"><i class="fa fa-check"></i><b>2.9</b> Customize the heatmap body</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#cell-fun"><i class="fa fa-check"></i><b>2.9.1</b> cell_fun</a></li>
<li class="chapter" data-level="2.9.2" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#layer-fun"><i class="fa fa-check"></i><b>2.9.2</b> layer_fun</a></li>
</ul></li>
<li class="chapter" data-level="2.10" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#size-of-the-heatmap"><i class="fa fa-check"></i><b>2.10</b> Size of the heatmap</a></li>
<li class="chapter" data-level="2.11" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#plot-the-heatmap"><i class="fa fa-check"></i><b>2.11</b> Plot the heatmap</a></li>
<li class="chapter" data-level="2.12" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#get-orders-and-dendrograms-from-heatmap"><i class="fa fa-check"></i><b>2.12</b> Get orders and dendrograms</a></li>
<li class="chapter" data-level="2.13" data-path="a-single-heatmap.html"><a href="a-single-heatmap.html#subset-a-heatmap"><i class="fa fa-check"></i><b>2.13</b> Subset a heatmap</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html"><i class="fa fa-check"></i><b>3</b> Heatmap Annotations</a>
<ul>
<li class="chapter" data-level="3.1" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#simple-annotation"><i class="fa fa-check"></i><b>3.1</b> Simple annotation</a></li>
<li class="chapter" data-level="3.2" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#simple-annotation-as-an-annotation-function"><i class="fa fa-check"></i><b>3.2</b> Simple annotation as an annotation function</a></li>
<li class="chapter" data-level="3.3" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#empty-annotation"><i class="fa fa-check"></i><b>3.3</b> Empty annotation</a></li>
<li class="chapter" data-level="3.4" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#block-annotation"><i class="fa fa-check"></i><b>3.4</b> Block annotation</a></li>
<li class="chapter" data-level="3.5" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#image-annotation"><i class="fa fa-check"></i><b>3.5</b> Image annotation</a></li>
<li class="chapter" data-level="3.6" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#points-annotation"><i class="fa fa-check"></i><b>3.6</b> Points annotation</a></li>
<li class="chapter" data-level="3.7" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#lines-annotation"><i class="fa fa-check"></i><b>3.7</b> Lines annotation</a></li>
<li class="chapter" data-level="3.8" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#barplot_annotation"><i class="fa fa-check"></i><b>3.8</b> Barplot annotation</a></li>
<li class="chapter" data-level="3.9" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#box-annotation"><i class="fa fa-check"></i><b>3.9</b> Boxplot annotation</a></li>
<li class="chapter" data-level="3.10" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#histogram-annotation"><i class="fa fa-check"></i><b>3.10</b> Histogram annotation</a></li>
<li class="chapter" data-level="3.11" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#density-annotation"><i class="fa fa-check"></i><b>3.11</b> Density annotation</a></li>
<li class="chapter" data-level="3.12" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#joyplot-annotation"><i class="fa fa-check"></i><b>3.12</b> Joyplot annotation</a></li>
<li class="chapter" data-level="3.13" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#horizon-chart-annotation"><i class="fa fa-check"></i><b>3.13</b> Horizon chart annotation</a></li>
<li class="chapter" data-level="3.14" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#text-annotation"><i class="fa fa-check"></i><b>3.14</b> Text annotation</a></li>
<li class="chapter" data-level="3.15" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#mark-annotation"><i class="fa fa-check"></i><b>3.15</b> Mark annotation</a></li>
<li class="chapter" data-level="3.16" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#summary-annotation"><i class="fa fa-check"></i><b>3.16</b> Summary annotation</a></li>
<li class="chapter" data-level="3.17" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#zoom-annotation"><i class="fa fa-check"></i><b>3.17</b> Zoom/link annotation</a></li>
<li class="chapter" data-level="3.18" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#multiple-annotations"><i class="fa fa-check"></i><b>3.18</b> Multiple annotations</a>
<ul>
<li class="chapter" data-level="3.18.1" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#size-of-annotations"><i class="fa fa-check"></i><b>3.18.1</b> Size of annotations</a></li>
<li class="chapter" data-level="3.18.2" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#annotation-labels"><i class="fa fa-check"></i><b>3.18.2</b> Annotation labels</a></li>
</ul></li>
<li class="chapter" data-level="3.19" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#heatmap-annotation-utility-function"><i class="fa fa-check"></i><b>3.19</b> Utility functions</a></li>
<li class="chapter" data-level="3.20" data-path="heatmap-annotations.html"><a href="heatmap-annotations.html#implement-new-annotation-functions"><i class="fa fa-check"></i><b>3.20</b> Implement new annotation functions</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html"><i class="fa fa-check"></i><b>4</b> A List of Heatmaps</a>
<ul>
<li class="chapter" data-level="4.1" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#heatmap-list-titles"><i class="fa fa-check"></i><b>4.1</b> Titles</a></li>
<li class="chapter" data-level="4.2" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#size-of-heatmaps"><i class="fa fa-check"></i><b>4.2</b> Size of heatmaps</a></li>
<li class="chapter" data-level="4.3" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#gap-between-heatmaps"><i class="fa fa-check"></i><b>4.3</b> Gap between heatmaps</a></li>
<li class="chapter" data-level="4.4" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#automatic-adjustment-to-the-main-heatmap"><i class="fa fa-check"></i><b>4.4</b> Automatic adjustment to the main heatmap</a></li>
<li class="chapter" data-level="4.5" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#control-main-heatmap-in-draw-function"><i class="fa fa-check"></i><b>4.5</b> Control main heatmap in draw() function</a></li>
<li class="chapter" data-level="4.6" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#annotations-as-components-are-adjusted"><i class="fa fa-check"></i><b>4.6</b> Annotations as components are adjusted</a></li>
<li class="chapter" data-level="4.7" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#concatenate-with-annotations"><i class="fa fa-check"></i><b>4.7</b> Concatenate with annotations</a></li>
<li class="chapter" data-level="4.8" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#concatenate-only-the-annotations"><i class="fa fa-check"></i><b>4.8</b> Concatenate only the annotations</a></li>
<li class="chapter" data-level="4.9" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#vertical-concatenation"><i class="fa fa-check"></i><b>4.9</b> Vertical concatenation</a></li>
<li class="chapter" data-level="4.10" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#subset-heatmap-list"><i class="fa fa-check"></i><b>4.10</b> Subset the heatmap list</a></li>
<li class="chapter" data-level="4.11" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#plot-the-heamtap-list"><i class="fa fa-check"></i><b>4.11</b> Plot the heatmap list</a></li>
<li class="chapter" data-level="4.12" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#get-orders-and-dendrograms-from-a-list-of-heatmaps"><i class="fa fa-check"></i><b>4.12</b> Get orders and dendrograms</a></li>
<li class="chapter" data-level="4.13" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#change-parameters-globally"><i class="fa fa-check"></i><b>4.13</b> Change parameters globally</a></li>
<li class="chapter" data-level="4.14" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#adjust-blank-space-caused-by-annotations"><i class="fa fa-check"></i><b>4.14</b> Adjust blank space caused by annotations</a></li>
<li class="chapter" data-level="4.15" data-path="a-list-of-heatmaps.html"><a href="a-list-of-heatmaps.html#manually-increase-space-around-the-plot"><i class="fa fa-check"></i><b>4.15</b> Manually increase space around the plot</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="legends.html"><a href="legends.html"><i class="fa fa-check"></i><b>5</b> Legends</a>
<ul>
<li class="chapter" data-level="5.1" data-path="legends.html"><a href="legends.html#continuous-legends"><i class="fa fa-check"></i><b>5.1</b> Continuous legends</a></li>
<li class="chapter" data-level="5.2" data-path="legends.html"><a href="legends.html#discrete-legends"><i class="fa fa-check"></i><b>5.2</b> Discrete legends</a></li>
<li class="chapter" data-level="5.3" data-path="legends.html"><a href="legends.html#a-list-of-legends"><i class="fa fa-check"></i><b>5.3</b> A list of legends</a></li>
<li class="chapter" data-level="5.4" data-path="legends.html"><a href="legends.html#heatmap-and-annotation-legends"><i class="fa fa-check"></i><b>5.4</b> Heatmap and annotation legends</a></li>
<li class="chapter" data-level="5.5" data-path="legends.html"><a href="legends.html#add-customized-legends"><i class="fa fa-check"></i><b>5.5</b> Add customized legends</a></li>
<li class="chapter" data-level="5.6" data-path="legends.html"><a href="legends.html#the-side-of-legends"><i class="fa fa-check"></i><b>5.6</b> The side of legends</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="heatmap-decoration.html"><a href="heatmap-decoration.html"><i class="fa fa-check"></i><b>6</b> Heatmap Decoration</a>
<ul>
<li class="chapter" data-level="6.1" data-path="heatmap-decoration.html"><a href="heatmap-decoration.html#decoration-functions"><i class="fa fa-check"></i><b>6.1</b> Decoration functions</a></li>
<li class="chapter" data-level="6.2" data-path="heatmap-decoration.html"><a href="heatmap-decoration.html#decoration-examples"><i class="fa fa-check"></i><b>6.2</b> Examples</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="heatmap-decoration.html"><a href="heatmap-decoration.html#barplot-for-single-column-heatmap"><i class="fa fa-check"></i><b>6.2.1</b> Barplot for single-column heatmap</a></li>
<li class="chapter" data-level="6.2.2" data-path="heatmap-decoration.html"><a href="heatmap-decoration.html#add-titles-for-row-annotations"><i class="fa fa-check"></i><b>6.2.2</b> Add titles for row annotations</a></li>
<li class="chapter" data-level="6.2.3" data-path="heatmap-decoration.html"><a href="heatmap-decoration.html#other-possible-use-of-decorations"><i class="fa fa-check"></i><b>6.2.3</b> Other possible use of decorations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="oncoprint.html"><a href="oncoprint.html"><i class="fa fa-check"></i><b>7</b> OncoPrint</a>
<ul>
<li class="chapter" data-level="7.1" data-path="oncoprint.html"><a href="oncoprint.html#oncoprint-general-settings"><i class="fa fa-check"></i><b>7.1</b> General settings</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="oncoprint.html"><a href="oncoprint.html#input-data-format"><i class="fa fa-check"></i><b>7.1.1</b> Input data format</a></li>
<li class="chapter" data-level="7.1.2" data-path="oncoprint.html"><a href="oncoprint.html#define-the-alter-fun"><i class="fa fa-check"></i><b>7.1.2</b> Define the alter_fun()</a></li>
<li class="chapter" data-level="7.1.3" data-path="oncoprint.html"><a href="oncoprint.html#oncoprint-background"><i class="fa fa-check"></i><b>7.1.3</b> Background</a></li>
<li class="chapter" data-level="7.1.4" data-path="oncoprint.html"><a href="oncoprint.html#complex-alteration-types"><i class="fa fa-check"></i><b>7.1.4</b> Complex alteration types</a></li>
<li class="chapter" data-level="7.1.5" data-path="oncoprint.html"><a href="oncoprint.html#simplify-alter_fun"><i class="fa fa-check"></i><b>7.1.5</b> Simplify alter_fun</a></li>
<li class="chapter" data-level="7.1.6" data-path="oncoprint.html"><a href="oncoprint.html#other-heatmap-related-settings"><i class="fa fa-check"></i><b>7.1.6</b> Other heatmap-related settings</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="oncoprint.html"><a href="oncoprint.html#apply-to-cbioportal-dataset"><i class="fa fa-check"></i><b>7.2</b> Apply to cBioPortal dataset</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="oncoprint.html"><a href="oncoprint.html#remove-empty-rows-and-columns"><i class="fa fa-check"></i><b>7.2.1</b> Remove empty rows and columns</a></li>
<li class="chapter" data-level="7.2.2" data-path="oncoprint.html"><a href="oncoprint.html#reorder-the-oncoprint"><i class="fa fa-check"></i><b>7.2.2</b> Reorder the oncoPrint</a></li>
<li class="chapter" data-level="7.2.3" data-path="oncoprint.html"><a href="oncoprint.html#oncoprint-annotations"><i class="fa fa-check"></i><b>7.2.3</b> OncoPrint annotations</a></li>
<li class="chapter" data-level="7.2.4" data-path="oncoprint.html"><a href="oncoprint.html#oncoprint-as-a-heatmap"><i class="fa fa-check"></i><b>7.2.4</b> oncoPrint as a Heatmap</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="upset-plot.html"><a href="upset-plot.html"><i class="fa fa-check"></i><b>8</b> UpSet plot</a>
<ul>
<li class="chapter" data-level="8.1" data-path="upset-plot.html"><a href="upset-plot.html#input-data"><i class="fa fa-check"></i><b>8.1</b> Input data</a></li>
<li class="chapter" data-level="8.2" data-path="upset-plot.html"><a href="upset-plot.html#upset-mode"><i class="fa fa-check"></i><b>8.2</b> Mode</a></li>
<li class="chapter" data-level="8.3" data-path="upset-plot.html"><a href="upset-plot.html#make-the-combination-matrix"><i class="fa fa-check"></i><b>8.3</b> Make the combination matrix</a></li>
<li class="chapter" data-level="8.4" data-path="upset-plot.html"><a href="upset-plot.html#upset-utility-functions"><i class="fa fa-check"></i><b>8.4</b> Utility functions</a></li>
<li class="chapter" data-level="8.5" data-path="upset-plot.html"><a href="upset-plot.html#upset-making-the-plot"><i class="fa fa-check"></i><b>8.5</b> Make the plot</a></li>
<li class="chapter" data-level="8.6" data-path="upset-plot.html"><a href="upset-plot.html#upset-plots-as-heatmaps"><i class="fa fa-check"></i><b>8.6</b> UpSet plots as heatmaps</a></li>
<li class="chapter" data-level="8.7" data-path="upset-plot.html"><a href="upset-plot.html#example-with-the-movies-dataset"><i class="fa fa-check"></i><b>8.7</b> Example with the movies dataset</a></li>
<li class="chapter" data-level="8.8" data-path="upset-plot.html"><a href="upset-plot.html#example-with-the-genomic-regions"><i class="fa fa-check"></i><b>8.8</b> Example with the genomic regions</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="more-examples.html"><a href="more-examples.html"><i class="fa fa-check"></i><b>9</b> More Examples</a>
<ul>
<li class="chapter" data-level="9.1" data-path="more-examples.html"><a href="more-examples.html#add-more-information-for-gene-expression-matrix"><i class="fa fa-check"></i><b>9.1</b> Add more information for gene expression matrix</a></li>
<li class="chapter" data-level="9.2" data-path="more-examples.html"><a href="more-examples.html#the-measles-vaccine-heatmap"><i class="fa fa-check"></i><b>9.2</b> The measles vaccine heatmap</a></li>
<li class="chapter" data-level="9.3" data-path="more-examples.html"><a href="more-examples.html#visualize-cell-heterogeneity-from-single-cell-rnaseq"><i class="fa fa-check"></i><b>9.3</b> Visualize Cell Heterogeneity from Single Cell RNASeq</a></li>
<li class="chapter" data-level="9.4" data-path="more-examples.html"><a href="more-examples.html#correlations-between-methylation-expression-and-other-genomic-features"><i class="fa fa-check"></i><b>9.4</b> Correlations between methylation, expression and other genomic features</a></li>
<li class="chapter" data-level="9.5" data-path="more-examples.html"><a href="more-examples.html#visualize-methylation-profile-with-complex-annotations"><i class="fa fa-check"></i><b>9.5</b> Visualize Methylation Profile with Complex Annotations</a></li>
<li class="chapter" data-level="9.6" data-path="more-examples.html"><a href="more-examples.html#add-multiple-boxplots-for-single-row"><i class="fa fa-check"></i><b>9.6</b> Add multiple boxplots for single row</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="other-high-level-plots.html"><a href="other-high-level-plots.html"><i class="fa fa-check"></i><b>10</b> Other High-level Plots</a>
<ul>
<li class="chapter" data-level="10.1" data-path="other-high-level-plots.html"><a href="other-high-level-plots.html#density-heatmap"><i class="fa fa-check"></i><b>10.1</b> Density heatmap</a></li>
<li class="chapter" data-level="10.2" data-path="other-high-level-plots.html"><a href="other-high-level-plots.html#stacked-summary-plot"><i class="fa fa-check"></i><b>10.2</b> Stacked summary plot</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="other-tricks.html"><a href="other-tricks.html"><i class="fa fa-check"></i><b>11</b> Other Tricks</a>
<ul>
<li class="chapter" data-level="11.1" data-path="other-tricks.html"><a href="other-tricks.html#set-the-same-cell-size-for-different-heatmaps-with-different-dimensions"><i class="fa fa-check"></i><b>11.1</b> Set the same cell size for different heatmaps with different dimensions</a></li>
<li class="chapter" data-level="11.2" data-path="other-tricks.html"><a href="other-tricks.html#integrate-with-gridtext-package"><i class="fa fa-check"></i><b>11.2</b> Integrate with gridtext package</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="other-tricks.html"><a href="other-tricks.html#titles"><i class="fa fa-check"></i><b>11.2.1</b> Titles</a></li>
<li class="chapter" data-level="11.2.2" data-path="other-tricks.html"><a href="other-tricks.html#rowcolumn-names"><i class="fa fa-check"></i><b>11.2.2</b> Row/column names</a></li>
<li class="chapter" data-level="11.2.3" data-path="other-tricks.html"><a href="other-tricks.html#annotation-labels-1"><i class="fa fa-check"></i><b>11.2.3</b> Annotation labels</a></li>
<li class="chapter" data-level="11.2.4" data-path="other-tricks.html"><a href="other-tricks.html#text-annotation-1"><i class="fa fa-check"></i><b>11.2.4</b> Text annotation</a></li>
<li class="chapter" data-level="11.2.5" data-path="other-tricks.html"><a href="other-tricks.html#legend"><i class="fa fa-check"></i><b>11.2.5</b> Legend</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">ComplexHeatmap Complete Reference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="a-single-heatmap" class="section level1" number="2">
<h1><span class="header-section-number">Chapter 2</span> A Single Heatmap</h1>
<p>A single heatmap is the most used approach for visualizing the data. Although
“the shining point” of the <strong>ComplexHeatmap</strong> package is it can visualize a
list of heatmaps in parallel, as the basic unit of the heatmap list, it is
still very important to have the single heatmap nicely configured.</p>
<p>First let’s generate a random matrix where there are three groups by columns
and three groups by rows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="a-single-heatmap.html#cb4-1"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-2"><a href="a-single-heatmap.html#cb4-2"></a>nr1 =<span class="st"> </span><span class="dv">4</span>; nr2 =<span class="st"> </span><span class="dv">8</span>; nr3 =<span class="st"> </span><span class="dv">6</span>; nr =<span class="st"> </span>nr1 <span class="op">+</span><span class="st"> </span>nr2 <span class="op">+</span><span class="st"> </span>nr3</span>
<span id="cb4-3"><a href="a-single-heatmap.html#cb4-3"></a>nc1 =<span class="st"> </span><span class="dv">6</span>; nc2 =<span class="st"> </span><span class="dv">8</span>; nc3 =<span class="st"> </span><span class="dv">10</span>; nc =<span class="st"> </span>nc1 <span class="op">+</span><span class="st"> </span>nc2 <span class="op">+</span><span class="st"> </span>nc3</span>
<span id="cb4-4"><a href="a-single-heatmap.html#cb4-4"></a>mat =<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">rbind</span>(<span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr1<span class="op">*</span>nc1, <span class="dt">mean =</span> <span class="dv">1</span>,   <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr1),</span>
<span id="cb4-5"><a href="a-single-heatmap.html#cb4-5"></a>          <span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr2<span class="op">*</span>nc1, <span class="dt">mean =</span> <span class="dv">0</span>,   <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr2),</span>
<span id="cb4-6"><a href="a-single-heatmap.html#cb4-6"></a>          <span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr3<span class="op">*</span>nc1, <span class="dt">mean =</span> <span class="dv">0</span>,   <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr3)),</span>
<span id="cb4-7"><a href="a-single-heatmap.html#cb4-7"></a>    <span class="kw">rbind</span>(<span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr1<span class="op">*</span>nc2, <span class="dt">mean =</span> <span class="dv">0</span>,   <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr1),</span>
<span id="cb4-8"><a href="a-single-heatmap.html#cb4-8"></a>          <span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr2<span class="op">*</span>nc2, <span class="dt">mean =</span> <span class="dv">1</span>,   <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr2),</span>
<span id="cb4-9"><a href="a-single-heatmap.html#cb4-9"></a>          <span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr3<span class="op">*</span>nc2, <span class="dt">mean =</span> <span class="dv">0</span>,   <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr3)),</span>
<span id="cb4-10"><a href="a-single-heatmap.html#cb4-10"></a>    <span class="kw">rbind</span>(<span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr1<span class="op">*</span>nc3, <span class="dt">mean =</span> <span class="fl">0.5</span>, <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr1),</span>
<span id="cb4-11"><a href="a-single-heatmap.html#cb4-11"></a>          <span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr2<span class="op">*</span>nc3, <span class="dt">mean =</span> <span class="fl">0.5</span>, <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr2),</span>
<span id="cb4-12"><a href="a-single-heatmap.html#cb4-12"></a>          <span class="kw">matrix</span>(<span class="kw">rnorm</span>(nr3<span class="op">*</span>nc3, <span class="dt">mean =</span> <span class="dv">1</span>,   <span class="dt">sd =</span> <span class="fl">0.5</span>), <span class="dt">nr =</span> nr3))</span>
<span id="cb4-13"><a href="a-single-heatmap.html#cb4-13"></a>   )</span>
<span id="cb4-14"><a href="a-single-heatmap.html#cb4-14"></a>mat =<span class="st"> </span>mat[<span class="kw">sample</span>(nr, nr), <span class="kw">sample</span>(nc, nc)] <span class="co"># random shuffle rows and columns</span></span>
<span id="cb4-15"><a href="a-single-heatmap.html#cb4-15"></a><span class="kw">rownames</span>(mat) =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;row&quot;</span>, <span class="kw">seq_len</span>(nr))</span>
<span id="cb4-16"><a href="a-single-heatmap.html#cb4-16"></a><span class="kw">colnames</span>(mat) =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;column&quot;</span>, <span class="kw">seq_len</span>(nc))</span></code></pre></div>
<p>Following command contains the minimal argument for the <code>Heatmap()</code> function
which just visualizes the matrix as a heatmap with default settings. Very
similar as other heatmap tools, it draws the dendrograms, the row/column names
and the heatmap legend. The default color schema is “blue-white-red” which is
mapped to the minimal-mean-maximal values in the matrix. The title for the
legend is assigned with an internal index number.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="a-single-heatmap.html#cb5-1"></a><span class="kw">Heatmap</span>(mat)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/default-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The title for the legend is taken from the “name” of the heatmap by default.
Each heatmap has a name which is like a unique identifier for the heatmap and
it is important when you have a list of heatmaps. In later chapters, you will
find the heatmap name is used for setting the “main heatmap” and is used for
decoration of heatmaps. If the name is not assigned, an internal name is
assigned to the heatmap in a form of <code>matrix_%d</code>. In following examples in
this chapter, we give the name <code>mat</code> to the heatmap (for which you will see
the change of the legend in the next plot).</p>
<p>If you put <code>Heatmap()</code> inside a function or a <code>for</code>/<code>if</code>/<code>while</code> chunk, you
won’t see the heatmap after executing <code>Heatmap()</code>. In this case, you need to
use <code>draw()</code> function explicitly as follows. We will explain this point in
more detail in Section <a href="a-single-heatmap.html#plot-the-heatmap">2.11</a>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="a-single-heatmap.html#cb6-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(mat)</span>
<span id="cb6-2"><a href="a-single-heatmap.html#cb6-2"></a><span class="kw">draw</span>(ht)</span></code></pre></div>
<div id="colors" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Colors</h2>
<p>For heatmap visualization, colors are the major representation of the data
matrix. In most cases, the heatmap visualizes a matrix with continuous numeric
values. In this case, users should provide a color mapping function. A color
mapping function should accept a vector of values and return a vector of
corresponding colors. <strong>Users should always use <code>circlize::colorRamp2()</code>
function to generate the color mapping function</strong> with using <code>Heatmap()</code>. The
two arguments for <code>colorRamp2()</code> is a vector of break values and a vector of
corresponding colors. <code>colorRamp2()</code> linearly interpolates colors in every
interval through LAB color space. Also using <code>colorRamp2()</code> helps to generate
a legend with proper tick marks.</p>
<p>In following example, values between -2 and 2 are linearly interpolated to get
corresponding colors, values larger than 2 are all mapped to red and values
less than -2 are all mapped to green.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="a-single-heatmap.html#cb7-1"></a><span class="kw">library</span>(circlize)</span>
<span id="cb7-2"><a href="a-single-heatmap.html#cb7-2"></a>col_fun =<span class="st"> </span><span class="kw">colorRamp2</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>))</span>
<span id="cb7-3"><a href="a-single-heatmap.html#cb7-3"></a><span class="kw">col_fun</span>(<span class="kw">seq</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>))</span></code></pre></div>
<pre><code>## [1] &quot;#00FF00FF&quot; &quot;#00FF00FF&quot; &quot;#B1FF9AFF&quot; &quot;#FFFFFFFF&quot; &quot;#FF9E81FF&quot; &quot;#FF0000FF&quot;
## [7] &quot;#FF0000FF&quot;</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="a-single-heatmap.html#cb9-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>As you can see, the color mapping function exactly maps negative values to
green and positive values to red, even when the distribution of negative
values and positive values are not centric to zero. Also this color mapping
function is not affected by outliers. In following plot, the clustering is
heavily affected by the outlier but not the color mapping.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="a-single-heatmap.html#cb10-1"></a>mat2 =<span class="st"> </span>mat</span>
<span id="cb10-2"><a href="a-single-heatmap.html#cb10-2"></a>mat2[<span class="dv">1</span>, <span class="dv">1</span>] =<span class="st"> </span><span class="dv">100000</span></span>
<span id="cb10-3"><a href="a-single-heatmap.html#cb10-3"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>More importantly, <code>colorRamp2()</code> makes colors in multiple heatmaps comparible
if they are set with a same color mapping function. In following three
heatmaps, a same color always corresponds to a same value.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="a-single-heatmap.html#cb11-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun, <span class="dt">column_title =</span> <span class="st">&quot;mat&quot;</span>)</span>
<span id="cb11-2"><a href="a-single-heatmap.html#cb11-2"></a><span class="kw">Heatmap</span>(mat<span class="op">/</span><span class="dv">4</span>, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun, <span class="dt">column_title =</span> <span class="st">&quot;mat/4&quot;</span>)</span>
<span id="cb11-3"><a href="a-single-heatmap.html#cb11-3"></a><span class="kw">Heatmap</span>(<span class="kw">abs</span>(mat), <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun, <span class="dt">column_title =</span> <span class="st">&quot;abs(mat)&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-5-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>If the matrix is continuous, you can also simply provide a vector of colors
and colors will be linearly interpolated. But remember this method is not
robust to outliers because the mapping starts from the minimal value in the
matrix and ends with the maximal value. Following color mapping setting is
identical to <code>colorRamp2(seq(min(mat), max(mat), length = 10), rev(rainbow(10)))</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="a-single-heatmap.html#cb12-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> <span class="kw">rev</span>(<span class="kw">rainbow</span>(<span class="dv">10</span>)))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If the matrix contains discrete values (either numeric or character), colors
should be specified as a named vector to make it possible for the mapping from
discrete values to colors. If there is no name for the color, the order of
colors corresponds to the order of <code>unique(mat)</code>. Note now the legend is
generated from the color mapping vector.</p>
<p>Following sets colors for a discrete numeric matrix (you don’t need to convert
it to a character matrix).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="a-single-heatmap.html#cb13-1"></a>discrete_mat =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">100</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>), <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb13-2"><a href="a-single-heatmap.html#cb13-2"></a>colors =<span class="st"> </span><span class="kw">structure</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>, <span class="st">&quot;4&quot;</span>)) <span class="co"># black, red, green, blue</span></span>
<span id="cb13-3"><a href="a-single-heatmap.html#cb13-3"></a><span class="kw">Heatmap</span>(discrete_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> colors)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Or a character matrix:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="a-single-heatmap.html#cb14-1"></a>discrete_mat =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">sample</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>], <span class="dv">100</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>), <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb14-2"><a href="a-single-heatmap.html#cb14-2"></a>colors =<span class="st"> </span><span class="kw">structure</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">names =</span> letters[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>])</span>
<span id="cb14-3"><a href="a-single-heatmap.html#cb14-3"></a><span class="kw">Heatmap</span>(discrete_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> colors)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/discrete_character_matrix-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>As you see in the two examples above, for the numeric matrix (no matter the
color is continuous mapping or discrete mapping), by default clustering is
applied on both dimensions while for character matrix, clustering is turned
off (but you can still cluster a character matrix if you provide a proper
distance metric for two character vectors, see example in Section
<a href="a-single-heatmap.html#distance-methods">2.3.1</a>).</p>
<p><code>NA</code> is allowed in the matrix. You can control the color of <code>NA</code> by <code>na_col</code>
argument (by default it is grey for <code>NA</code>). <strong>The matrix that contains <code>NA</code> can
be clustered by <code>Heatmap()</code>.</strong></p>
<p>Note the <code>NA</code> value is not presented in the legend.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="a-single-heatmap.html#cb15-1"></a>mat_with_na =<span class="st"> </span>mat</span>
<span id="cb15-2"><a href="a-single-heatmap.html#cb15-2"></a>na_index =<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>), <span class="kw">nrow</span>(mat)<span class="op">*</span><span class="kw">ncol</span>(mat), <span class="dt">replace =</span> <span class="ot">TRUE</span>, <span class="dt">prob =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">9</span>))</span>
<span id="cb15-3"><a href="a-single-heatmap.html#cb15-3"></a>mat_with_na[na_index] =<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb15-4"><a href="a-single-heatmap.html#cb15-4"></a><span class="kw">Heatmap</span>(mat_with_na, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">na_col =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Color space is important for interpolating colors. By default, colors are
linearly interpolated in <a href="https://en.wikipedia.org/wiki/Lab_color_space">LAB color
space</a>, but you can select the
color space in <code>colorRamp2()</code> function. Compare following two plots. Can you
see the difference?</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="a-single-heatmap.html#cb16-1"></a>f1 =<span class="st"> </span><span class="kw">colorRamp2</span>(<span class="kw">seq</span>(<span class="kw">min</span>(mat), <span class="kw">max</span>(mat), <span class="dt">length =</span> <span class="dv">3</span>), <span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;#EEEEEE&quot;</span>, <span class="st">&quot;red&quot;</span>))</span>
<span id="cb16-2"><a href="a-single-heatmap.html#cb16-2"></a>f2 =<span class="st"> </span><span class="kw">colorRamp2</span>(<span class="kw">seq</span>(<span class="kw">min</span>(mat), <span class="kw">max</span>(mat), <span class="dt">length =</span> <span class="dv">3</span>), <span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;#EEEEEE&quot;</span>, <span class="st">&quot;red&quot;</span>), </span>
<span id="cb16-3"><a href="a-single-heatmap.html#cb16-3"></a>    <span class="dt">space =</span> <span class="st">&quot;RGB&quot;</span>)</span>
<span id="cb16-4"><a href="a-single-heatmap.html#cb16-4"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat1&quot;</span>, <span class="dt">col =</span> f1, <span class="dt">column_title =</span> <span class="st">&quot;LAB color space&quot;</span>)</span>
<span id="cb16-5"><a href="a-single-heatmap.html#cb16-5"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat2&quot;</span>, <span class="dt">col =</span> f2, <span class="dt">column_title =</span> <span class="st">&quot;RGB color space&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-10-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>In following plots, corresponding values change evenly on the folded lines,
you can see how colors change under different color spaces (top plots:
green-black-red, bottom plots: blue-white-red. The plot is made by
<a href="https://bioconductor.org/packages/release/bioc/html/HilbertCurve.html"><strong>HilbertCurve</strong>package</a>).</p>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-11-1.png" width="1344" style="display: block; margin: auto;" /><img src="02-single_heatmap_files/figure-html/unnamed-chunk-11-2.png" width="1344" style="display: block; margin: auto;" /></p>
<p>Last but not the least, colors for the heatmap borders can be set by the
<code>border</code> and <code>rect_gp</code> arguments. <code>border</code> controls the global border of the
heatmap body and <code>rect_gp</code> controls the border of the grids in the heatmap.</p>
<p>The value of <code>border</code> can be logical (<code>TRUE</code> corresponds to <code>black</code>) or a
character of color (e.g. <code>red</code>).</p>
<p><code>rect_gp</code> is a <code>gpar</code> object which means you can only set it by
<code>grid::gpar()</code>. Since the filled color is already controlled by the heatmap
color mapping, you can only set the <code>col</code> parameter in <code>gpar()</code> to control the
border of the heatmap grids.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="a-single-heatmap.html#cb17-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">border =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="a-single-heatmap.html#cb18-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">rect_gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-12-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>If <code>col</code> is not set, the default color mapping by <code>Heatmap()</code> is designed with
trying to be as convinient and meaningful as possible. Following are the rules
for the default color mapping (by <code>ComplexHeatmap:::default_col()</code>):</p>
<ul>
<li>If the values are characters, the colors are generated by
<code>circlize::rand_color()</code>;</li>
<li>If the values are from the heatmap annotation and are numeric, colors are
mapped between white and one random color by linearly interpolating to the
mininum and maxinum.</li>
<li>If the values are from the matrix (let’s denote it as <span class="math inline">\(M\)</span>) which corresponds
to the heatmap body:
<ul>
<li>If the fraction of positive values in <span class="math inline">\(M\)</span> is between 25% and 75%, colors
are mapped to blue, white and red by linearly interpolating to <span class="math inline">\(-q\)</span>, 0
and <span class="math inline">\(q\)</span>, where <span class="math inline">\(q\)</span> is the maximum of <span class="math inline">\(|M|\)</span> if the number of unique
values is less than 100, or <span class="math inline">\(q\)</span> is the 99^th percentile of <span class="math inline">\(|M|\)</span>. This
color mapping is centric to zero.</li>
<li>Or else the colors are mapped to blue, white and red by linearly
interpolating to <span class="math inline">\(q_1\)</span>, <span class="math inline">\((q_1 + q_2)/2\)</span> and <span class="math inline">\(q_2\)</span>, where <span class="math inline">\(q_1\)</span> and <span class="math inline">\(q_2\)</span>
are mininum and maxinum if the number of unique values is <span class="math inline">\(M\)</span> is less
than 100, or <span class="math inline">\(q1\)</span> is the 1^th percentile and <span class="math inline">\(q2\)</span> is the 99^th
percentile in <span class="math inline">\(M\)</span>.</li>
</ul></li>
</ul>
<p><code>rect_gp</code> allows a non-standard parameter <code>type</code>. If it is set to <code>"none"</code>,
the clustering is still applied but nothing in drawn on the heatmap body. The
customized graphics on heatmap body can be added via a self-defined <code>cell_fun</code>
or <code>layer_fun</code> (see Section <a href="a-single-heatmap.html#customize-the-heatmap-body">2.9</a>).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="a-single-heatmap.html#cb19-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">rect_gp =</span> <span class="kw">gpar</span>(<span class="dt">type =</span> <span class="st">&quot;none&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="heatmap-titles" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Titles</h2>
<p>The title of the heatmap basically tells what the plot is about. In
<strong>ComplexHeatmap</strong> package, you can set heatmap title either by the row or/and
by the column. Note at a same time you can only put e.g. column title either
on the top or at the bottom of the heatmap.</p>
<p>The graphic parameters can be set by <code>row_title_gp</code> and <code>column_title_gp</code>
respectively. Please remember you should use <code>gpar()</code> to specify graphic
parameters.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="a-single-heatmap.html#cb20-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_title =</span> <span class="st">&quot;I am a column title&quot;</span>, </span>
<span id="cb20-2"><a href="a-single-heatmap.html#cb20-2"></a>    <span class="dt">row_title =</span> <span class="st">&quot;I am a row title&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/row_column_title-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="a-single-heatmap.html#cb21-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_title =</span> <span class="st">&quot;I am a column title at the bottom&quot;</span>, </span>
<span id="cb21-2"><a href="a-single-heatmap.html#cb21-2"></a>    <span class="dt">column_title_side =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/row_column_title-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="a-single-heatmap.html#cb22-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_title =</span> <span class="st">&quot;I am a big column title&quot;</span>, </span>
<span id="cb22-2"><a href="a-single-heatmap.html#cb22-2"></a>    <span class="dt">column_title_gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">20</span>, <span class="dt">fontface =</span> <span class="st">&quot;bold&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/row_column_title-3.png" width="672" style="display: block; margin: auto;" /></p>
<p>Rotations for titles can be set by <code>row_title_rot</code> and <code>column_title_rot</code>, but
only horizontal and vertical rotations are allowed.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="a-single-heatmap.html#cb23-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_title =</span> <span class="st">&quot;row title&quot;</span>, <span class="dt">row_title_rot =</span> <span class="dv">0</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/title_rotation-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Row or column title supports as a template which is used when rows or columns
are split in the heatmap (because there will be multiple row/column titles).
This functionality is introduced in Section <a href="a-single-heatmap.html#heatmap-split">2.7</a>. A quick
example would be:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="a-single-heatmap.html#cb24-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb24-2"><a href="a-single-heatmap.html#cb24-2"></a><span class="co"># row title would be cluster_1 and cluster_2</span></span>
<span id="cb24-3"><a href="a-single-heatmap.html#cb24-3"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">row_title =</span> <span class="st">&quot;cluster_%s&quot;</span>)</span></code></pre></div>
<p>You can set <code>fill</code> parameter in <code>row_title_gp</code> and <code>column_title_gp</code> to set
the background color of titles. Since <code>col</code> in e.g. <code>row_title_gp</code> controls the
color of text, <code>border</code> is used to control the color of the background border.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="a-single-heatmap.html#cb25-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_title =</span> <span class="st">&quot;I am a column title&quot;</span>, </span>
<span id="cb25-2"><a href="a-single-heatmap.html#cb25-2"></a>    <span class="dt">column_title_gp =</span> <span class="kw">gpar</span>(<span class="dt">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">border =</span> <span class="st">&quot;red&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If the graphic elements are texts, they can be set as mathematical formulas.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="a-single-heatmap.html#cb26-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb26-2"><a href="a-single-heatmap.html#cb26-2"></a>    <span class="dt">column_title =</span> <span class="kw">expression</span>(<span class="kw">hat</span>(beta) <span class="op">==</span><span class="st"> </span>(X<span class="op">^</span>t <span class="op">*</span><span class="st"> </span>X)<span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>} <span class="op">*</span><span class="st"> </span>X<span class="op">^</span>t <span class="op">*</span><span class="st"> </span>y)) </span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="clustering" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Clustering</h2>
<p>Clustering might be the key component of the heatmap visualization. In
<strong>ComplexHeatmap</strong> package, hierarchical clustering is supported with great
flexibility. You can specify the clustering either by:</p>
<ul>
<li>a pre-defined distance method (e.g. <code>"euclidean"</code> or <code>"pearson"</code>),</li>
<li>a distance function,</li>
<li>a object that already contains clustering (a <code>hclust</code> or <code>dendrogram</code> object
or object that can be coerced to <code>dendrogram</code> class),</li>
<li>a clustering function.</li>
</ul>
<p>It is also possible to render the dendrograms with different colors and styles
for different branches for better revealing structures of the dendrogram (e.g.
by <code>dendextend::color_branches()</code>).</p>
<p>First, there are general settings for the clustering, e.g. whether apply
clustering or show dendrograms, the side of the dendrograms and heights of the
dendrograms.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="a-single-heatmap.html#cb27-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>) <span class="co"># turn off row clustering</span></span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_basic-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="a-single-heatmap.html#cb28-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">show_column_dend =</span> <span class="ot">FALSE</span>) <span class="co"># hide column dendrogram</span></span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_basic-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="a-single-heatmap.html#cb29-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_dend_side =</span> <span class="st">&quot;right&quot;</span>, <span class="dt">column_dend_side =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_basic-3.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="a-single-heatmap.html#cb30-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_dend_height =</span> <span class="kw">unit</span>(<span class="dv">4</span>, <span class="st">&quot;cm&quot;</span>), </span>
<span id="cb30-2"><a href="a-single-heatmap.html#cb30-2"></a>    <span class="dt">row_dend_width =</span> <span class="kw">unit</span>(<span class="dv">4</span>, <span class="st">&quot;cm&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_basic-4.png" width="672" style="display: block; margin: auto;" /></p>
<div id="distance-methods" class="section level3" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> Distance methods</h3>
<p>Hierarchical clustering is performed in two steps: calculate the distance
matrix and apply clustering. There are three ways to specify distance metric
for clustering:</p>
<ul>
<li>specify distance as a pre-defined option. The valid values are the supported
methods in <code>dist()</code> function and in <code>"pearson"</code>, <code>"spearman"</code> and
<code>"kendall"</code>. The correlation distance is defined as <code>1 - cor(x, y, method)</code>.
All these built-in distance methods allow <code>NA</code> values.</li>
<li>a self-defined function which calculates distance from a matrix. The
function should only contain one argument. Please note for clustering on
columns, the matrix will be transposed automatically.</li>
<li>a self-defined function which calculates distance from two vectors. The
function should only contain two arguments. Note this might be slow because
it is implemented by two nested <code>for</code> loop.</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="a-single-heatmap.html#cb31-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">clustering_distance_rows =</span> <span class="st">&quot;pearson&quot;</span>,</span>
<span id="cb31-2"><a href="a-single-heatmap.html#cb31-2"></a>    <span class="dt">column_title =</span> <span class="st">&quot;pre-defined distance method (1 - pearson)&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_distance-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="a-single-heatmap.html#cb32-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">clustering_distance_rows =</span> <span class="cf">function</span>(m) <span class="kw">dist</span>(m),</span>
<span id="cb32-2"><a href="a-single-heatmap.html#cb32-2"></a>    <span class="dt">column_title =</span> <span class="st">&quot;a function that calculates distance matrix&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_distance-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="a-single-heatmap.html#cb33-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">clustering_distance_rows =</span> <span class="cf">function</span>(x, y) <span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">cor</span>(x, y),</span>
<span id="cb33-2"><a href="a-single-heatmap.html#cb33-2"></a>    <span class="dt">column_title =</span> <span class="st">&quot;a function that calculates pairwise distance&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_distance-3.png" width="672" style="display: block; margin: auto;" /></p>
<p>Based on these features, we can apply clustering which is robust to outliers
based on the pairwise distance. Note here we set the color mapping function
because we don’t want outliers affect the colors.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="a-single-heatmap.html#cb34-1"></a>mat_with_outliers =<span class="st"> </span>mat</span>
<span id="cb34-2"><a href="a-single-heatmap.html#cb34-2"></a><span class="cf">for</span>(i <span class="cf">in</span>  <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) mat_with_outliers[i, i] =<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb34-3"><a href="a-single-heatmap.html#cb34-3"></a>robust_dist =<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb34-4"><a href="a-single-heatmap.html#cb34-4"></a>    qx =<span class="st"> </span><span class="kw">quantile</span>(x, <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>))</span>
<span id="cb34-5"><a href="a-single-heatmap.html#cb34-5"></a>    qy =<span class="st"> </span><span class="kw">quantile</span>(y, <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>))</span>
<span id="cb34-6"><a href="a-single-heatmap.html#cb34-6"></a>    l =<span class="st"> </span>x <span class="op">&gt;</span><span class="st"> </span>qx[<span class="dv">1</span>] <span class="op">&amp;</span><span class="st"> </span>x <span class="op">&lt;</span><span class="st"> </span>qx[<span class="dv">2</span>] <span class="op">&amp;</span><span class="st"> </span>y <span class="op">&gt;</span><span class="st"> </span>qy[<span class="dv">1</span>] <span class="op">&amp;</span><span class="st"> </span>y <span class="op">&lt;</span><span class="st"> </span>qy[<span class="dv">2</span>]</span>
<span id="cb34-7"><a href="a-single-heatmap.html#cb34-7"></a>    x =<span class="st"> </span>x[l]</span>
<span id="cb34-8"><a href="a-single-heatmap.html#cb34-8"></a>    y =<span class="st"> </span>y[l]</span>
<span id="cb34-9"><a href="a-single-heatmap.html#cb34-9"></a>    <span class="kw">sqrt</span>(<span class="kw">sum</span>((x <span class="op">-</span><span class="st"> </span>y)<span class="op">^</span><span class="dv">2</span>))</span>
<span id="cb34-10"><a href="a-single-heatmap.html#cb34-10"></a>}</span></code></pre></div>
<p>We can compare the two heatmaps with or without the robust distance method:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="a-single-heatmap.html#cb35-1"></a><span class="kw">Heatmap</span>(mat_with_outliers, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb35-2"><a href="a-single-heatmap.html#cb35-2"></a>    <span class="dt">col =</span> <span class="kw">colorRamp2</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>)),</span>
<span id="cb35-3"><a href="a-single-heatmap.html#cb35-3"></a>    <span class="dt">column_title =</span> <span class="st">&quot;dist&quot;</span>)</span>
<span id="cb35-4"><a href="a-single-heatmap.html#cb35-4"></a><span class="kw">Heatmap</span>(mat_with_outliers, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb35-5"><a href="a-single-heatmap.html#cb35-5"></a>    <span class="dt">col =</span> <span class="kw">colorRamp2</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>)),</span>
<span id="cb35-6"><a href="a-single-heatmap.html#cb35-6"></a>    <span class="dt">clustering_distance_rows =</span> robust_dist,</span>
<span id="cb35-7"><a href="a-single-heatmap.html#cb35-7"></a>    <span class="dt">clustering_distance_columns =</span> robust_dist,</span>
<span id="cb35-8"><a href="a-single-heatmap.html#cb35-8"></a>    <span class="dt">column_title =</span> <span class="st">&quot;robust_dist&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-18-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>If there are proper distance methods (like methods in <a href="https://cran.r-project.org/web/packages/stringdist/"><strong>stringdist</strong>
package</a>), you can also
cluster a character matrix. <code>cell_fun</code> argument will be introduced in Section
<a href="a-single-heatmap.html#customize-the-heatmap-body">2.9</a>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="a-single-heatmap.html#cb36-1"></a>mat_letters =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">sample</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>], <span class="dv">100</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>), <span class="dv">10</span>)</span>
<span id="cb36-2"><a href="a-single-heatmap.html#cb36-2"></a><span class="co"># distance in the ASCII table</span></span>
<span id="cb36-3"><a href="a-single-heatmap.html#cb36-3"></a>dist_letters =<span class="st"> </span><span class="cf">function</span>(x, y) {</span>
<span id="cb36-4"><a href="a-single-heatmap.html#cb36-4"></a>    x =<span class="st"> </span><span class="kw">strtoi</span>(<span class="kw">charToRaw</span>(<span class="kw">paste</span>(x, <span class="dt">collapse =</span> <span class="st">&quot;&quot;</span>)), <span class="dt">base =</span> <span class="dv">16</span>)</span>
<span id="cb36-5"><a href="a-single-heatmap.html#cb36-5"></a>    y =<span class="st"> </span><span class="kw">strtoi</span>(<span class="kw">charToRaw</span>(<span class="kw">paste</span>(y, <span class="dt">collapse =</span> <span class="st">&quot;&quot;</span>)), <span class="dt">base =</span> <span class="dv">16</span>)</span>
<span id="cb36-6"><a href="a-single-heatmap.html#cb36-6"></a>    <span class="kw">sqrt</span>(<span class="kw">sum</span>((x <span class="op">-</span><span class="st"> </span>y)<span class="op">^</span><span class="dv">2</span>))</span>
<span id="cb36-7"><a href="a-single-heatmap.html#cb36-7"></a>}</span>
<span id="cb36-8"><a href="a-single-heatmap.html#cb36-8"></a><span class="kw">Heatmap</span>(mat_letters, <span class="dt">name =</span> <span class="st">&quot;letters&quot;</span>, <span class="dt">col =</span> <span class="kw">structure</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">names =</span> letters[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]),</span>
<span id="cb36-9"><a href="a-single-heatmap.html#cb36-9"></a>    <span class="dt">clustering_distance_rows =</span> dist_letters, <span class="dt">clustering_distance_columns =</span> dist_letters,</span>
<span id="cb36-10"><a href="a-single-heatmap.html#cb36-10"></a>    <span class="dt">cell_fun =</span> <span class="cf">function</span>(j, i, x, y, w, h, col) { <span class="co"># add text to each grid</span></span>
<span id="cb36-11"><a href="a-single-heatmap.html#cb36-11"></a>        <span class="kw">grid.text</span>(mat_letters[i, j], x, y)</span>
<span id="cb36-12"><a href="a-single-heatmap.html#cb36-12"></a>    })</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_character_matrix-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="clustering-methods" class="section level3" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Clustering methods</h3>
<p>Method to perform hierarchical clustering can be specified by
<code>clustering_method_rows</code> and <code>clustering_method_columns</code>. Possible methods are
those supported in <code>hclust()</code> function.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="a-single-heatmap.html#cb37-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">clustering_method_rows =</span> <span class="st">&quot;single&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_method-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If you already have a clustering object or a function which directly returns a
clustering object, you can ignore the distance settings and set <code>cluster_rows</code>
or <code>cluster_columns</code> to the clustering objects or clustering functions. If it
is a clustering function, the only argument should be the matrix and it should
return a <code>hclust</code> or <code>dendrogram</code> object or a object that can be coerced to
the <code>dendrogram</code> class.</p>
<p>In following example, we perform clustering with methods from <strong>cluster</strong>
package either by a pre-calculated clustering object or a clustering function:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="a-single-heatmap.html#cb38-1"></a><span class="kw">library</span>(cluster)</span>
<span id="cb38-2"><a href="a-single-heatmap.html#cb38-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> <span class="kw">diana</span>(mat),</span>
<span id="cb38-3"><a href="a-single-heatmap.html#cb38-3"></a>   <span class="dt">cluster_columns =</span> <span class="kw">agnes</span>(<span class="kw">t</span>(mat)), <span class="dt">column_title =</span> <span class="st">&quot;clustering objects&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_object-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="a-single-heatmap.html#cb39-1"></a><span class="co"># if cluster_columns is set as a function, you don&#39;t need to transpose the matrix</span></span>
<span id="cb39-2"><a href="a-single-heatmap.html#cb39-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> diana,</span>
<span id="cb39-3"><a href="a-single-heatmap.html#cb39-3"></a>   <span class="dt">cluster_columns =</span> agnes, <span class="dt">column_title =</span> <span class="st">&quot;clustering functions&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_object-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>The last command is as same as :</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="a-single-heatmap.html#cb40-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb40-2"><a href="a-single-heatmap.html#cb40-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> <span class="cf">function</span>(m) <span class="kw">as.dendrogram</span>(<span class="kw">diana</span>(m)),</span>
<span id="cb40-3"><a href="a-single-heatmap.html#cb40-3"></a>    <span class="dt">cluster_columns =</span> <span class="cf">function</span>(m) <span class="kw">as.dendrogram</span>(<span class="kw">agnes</span>(m)), </span>
<span id="cb40-4"><a href="a-single-heatmap.html#cb40-4"></a>    <span class="dt">column_title =</span> <span class="st">&quot;clutering functions&quot;</span>)</span></code></pre></div>
<p>Please note, when <code>cluster_rows</code> is set as a function, the argument <code>m</code> is the
input <code>mat</code> itself, while for <code>cluster_columns</code>, <code>m</code> is the transpose of
<code>mat</code>.</p>
<p><code>fastcluster::hclust</code> implements a faster version of <code>hclust()</code>. You can set
it to <code>cluster_rows</code> and <code>cluster_columns</code> to use the faster version of
<code>hclust()</code>.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="a-single-heatmap.html#cb41-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb41-2"><a href="a-single-heatmap.html#cb41-2"></a>fh =<span class="st"> </span><span class="cf">function</span>(x) fastcluster<span class="op">::</span><span class="kw">hclust</span>(<span class="kw">dist</span>(x))</span>
<span id="cb41-3"><a href="a-single-heatmap.html#cb41-3"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> fh, <span class="dt">cluster_columns =</span> fh)</span></code></pre></div>
<p>To make it more convinient to use the faster version of <code>hclust()</code> (assuming
you have many heatmaps to construct), it can be set as a global option. The
usage of <code>ht_opt</code> is introduced in Section
<a href="a-list-of-heatmaps.html#change-parameters-globally">4.13</a>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="a-single-heatmap.html#cb42-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb42-2"><a href="a-single-heatmap.html#cb42-2"></a>ht_opt<span class="op">$</span>fast_hclust =<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb42-3"><a href="a-single-heatmap.html#cb42-3"></a><span class="co"># now fastcluster::hclust is used in all heatmaps</span></span></code></pre></div>
<p>This is one specific scenario that you might already have a subgroup
classification for the matrix rows or columns, and you only want to perform
clustering for the features in the same subgroup. There is one way that you
can split the heatmap by the subgroup variable (see Section
<a href="a-single-heatmap.html#heatmap-split">2.7</a>), or you can use <code>cluster_within_group()</code> clustering
function to generate a special dendrogram.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="a-single-heatmap.html#cb43-1"></a>group =<span class="st"> </span><span class="kw">kmeans</span>(<span class="kw">t</span>(mat), <span class="dt">centers =</span> <span class="dv">3</span>)<span class="op">$</span>cluster</span>
<span id="cb43-2"><a href="a-single-heatmap.html#cb43-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_columns =</span> <span class="kw">cluster_within_group</span>(mat, group))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-22-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>In above example, columns in a same group are still clustered, but the
dendrogram is degenerated as a flat line. The dendrogram on columns shows the
hierarchy of the groups.</p>
</div>
<div id="render-dendrograms" class="section level3" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Render dendrograms</h3>
<p>If you want to render the dendrogram, normally you need to generate a
<code>dendrogram</code> object and render it in the first place, then send it to the
<code>cluster_rows</code> or <code>cluster_columns</code> argument.</p>
<p>You can render your <code>dendrogram</code> object by the <strong>dendextend</strong> package to make
a more customized visualization of the dendrogram. Note <strong>ComplexHeatmap</strong>
only allows rendering on the dendrogram lines.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="a-single-heatmap.html#cb44-1"></a><span class="kw">library</span>(dendextend)</span>
<span id="cb44-2"><a href="a-single-heatmap.html#cb44-2"></a>row_dend =<span class="st"> </span><span class="kw">as.dendrogram</span>(<span class="kw">hclust</span>(<span class="kw">dist</span>(mat)))</span>
<span id="cb44-3"><a href="a-single-heatmap.html#cb44-3"></a>row_dend =<span class="st"> </span><span class="kw">color_branches</span>(row_dend, <span class="dt">k =</span> <span class="dv">2</span>) <span class="co"># `color_branches()` returns a dendrogram object</span></span>
<span id="cb44-4"><a href="a-single-heatmap.html#cb44-4"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> row_dend)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_dendextend-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><code>row_dend_gp</code> and <code>column_dend_gp</code> control the global graphic setting for
dendrograms. Note e.g. graphic settings in <code>row_dend</code> will be overwritten by
<code>row_dend_gp</code>.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="a-single-heatmap.html#cb45-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> row_dend, <span class="dt">row_dend_gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> <span class="st">&quot;red&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="reorder-dendrograms" class="section level3" number="2.3.4">
<h3><span class="header-section-number">2.3.4</span> Reorder dendrograms</h3>
<p>In the <code>Heatmap()</code> function, dendrograms are reordered to make features with
larger difference more separated from each others (please refer to the
documentation of <code>reorder.dendrogram()</code>). Here the difference (or it is called
the weight) is measured by the row means if it is a row dendrogram or by the
column means if it is a column dendrogram. <code>row_dend_reorder</code> and
<code>column_dend_reorder</code> control whether to apply dendrogram reordering if the
value is set as logical. The two arguments also control the weight for the
reordering if they are set to numeric vectors (it will be sent to the <code>wts</code>
argument of <code>reorder.dendrogram()</code>). The reordering can be turned off by
setting e.g. <code>row_dend_reorder = FALSE</code>.</p>
<p>By default, dendrogram reordering is turned on if
<code>cluster_rows</code>/<code>cluster_columns</code> is set as logical value or a clustering
function. It is turned off if <code>cluster_rows</code>/<code>cluster_columns</code> is set as
clustering object.</p>
<p>Compare following two heatmaps:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="a-single-heatmap.html#cb46-1"></a>m2 =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="dt">nr =</span> <span class="dv">10</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</span>
<span id="cb46-2"><a href="a-single-heatmap.html#cb46-2"></a><span class="kw">Heatmap</span>(m2, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_dend_reorder =</span> <span class="ot">FALSE</span>, <span class="dt">column_title =</span> <span class="st">&quot;no reordering&quot;</span>)</span>
<span id="cb46-3"><a href="a-single-heatmap.html#cb46-3"></a><span class="kw">Heatmap</span>(m2, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_dend_reorder =</span> <span class="ot">TRUE</span>, <span class="dt">column_title =</span> <span class="st">&quot;apply reordering&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cluster_dendsort-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>There are many other methods for reordering dendrograms, e.g. the <strong>dendsort</strong>
package. Basically, all these methods still return a dendrogram that has been
reordered, thus, we can firstly generate the row or column dendrogram based on
the data matrix, reorder it by some method, and assign it back to
<code>cluster_rows</code> or <code>cluster_columns</code>.</p>
<p>Compare following two reorderings. Can you tell which is better?</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="a-single-heatmap.html#cb47-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_title =</span> <span class="st">&quot;default reordering&quot;</span>)</span>
<span id="cb47-2"><a href="a-single-heatmap.html#cb47-2"></a></span>
<span id="cb47-3"><a href="a-single-heatmap.html#cb47-3"></a><span class="kw">library</span>(dendsort)</span>
<span id="cb47-4"><a href="a-single-heatmap.html#cb47-4"></a>dend =<span class="st"> </span><span class="kw">dendsort</span>(<span class="kw">hclust</span>(<span class="kw">dist</span>(mat)))</span>
<span id="cb47-5"><a href="a-single-heatmap.html#cb47-5"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> dend, <span class="dt">column_title =</span> <span class="st">&quot;reorder by dendsort&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-26-1.png" width="960" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="row-and_column_orders" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Set row and column orders</h2>
<p>Clustering is used to adjust row orders and column orders of the heatmap, but
you can still set the order manually by <code>row_order</code> and <code>column_order</code>. If
e.g. <code>row_order</code> is set, row clustering is turned off by default.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="a-single-heatmap.html#cb48-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_order =</span> <span class="kw">order</span>(<span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">rownames</span>(mat)))), </span>
<span id="cb48-2"><a href="a-single-heatmap.html#cb48-2"></a>    <span class="dt">column_order =</span> <span class="kw">order</span>(<span class="kw">as.numeric</span>(<span class="kw">gsub</span>(<span class="st">&quot;column&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">colnames</span>(mat)))))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/manual_order-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The orders can be character vectors if they are just shuffles of the matrix row names or column names.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="a-single-heatmap.html#cb49-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_order =</span> <span class="kw">sort</span>(<span class="kw">rownames</span>(mat)), </span>
<span id="cb49-2"><a href="a-single-heatmap.html#cb49-2"></a>    <span class="dt">column_order =</span> <span class="kw">sort</span>(<span class="kw">colnames</span>(mat)))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Note <code>row_dend_reorder</code> and <code>row_order</code> are two different things.
<code>row_dend_reorder</code> is applied on the dendrogram. For any node in the
dendrogram, rotating its two branches actually gives an identical dendrogram,
thus, reordering the dendrogram by automatically rotating sub-dendrogram at
every node can help to separate elements further from each other which show
more difference. As a comparison, <code>row_order</code> is simply applied on the matrix
and normally dendrograms should be turned off.</p>
</div>
<div id="heatmap-seriation" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> Seriation</h2>
<p>Seriation is an interesting technique for ordering the matrix (see this
interesting post: <a href="http://nicolas.kruchten.com/content/2018/02/seriation/" class="uri">http://nicolas.kruchten.com/content/2018/02/seriation/</a>). The
powerful <a href="https://cran.r-project.org/web/packages/seriation/index.html"><strong>seriation</strong>
package</a>
implements quite a lot of methods for seriation. Since it is easy to extract
row orders and column orders from the object returned by the core function
<code>seriate()</code> from <strong>seriation</strong> package. They can be directly assigned to
<code>row_order</code> and <code>column_order</code> to make the heatmap.</p>
<p>The first example demonstrates to directly apply <code>seriate()</code> on the matrix.
Since the <code>"BEA_TSP"</code> method only allows a non-negative matrix, we modify the
matrix to <code>max(mat) - mat</code>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="a-single-heatmap.html#cb50-1"></a><span class="kw">library</span>(seriation)</span>
<span id="cb50-2"><a href="a-single-heatmap.html#cb50-2"></a>o =<span class="st"> </span><span class="kw">seriate</span>(<span class="kw">max</span>(mat) <span class="op">-</span><span class="st"> </span>mat, <span class="dt">method =</span> <span class="st">&quot;BEA_TSP&quot;</span>)</span>
<span id="cb50-3"><a href="a-single-heatmap.html#cb50-3"></a><span class="kw">Heatmap</span>(<span class="kw">max</span>(mat) <span class="op">-</span><span class="st"> </span>mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb50-4"><a href="a-single-heatmap.html#cb50-4"></a>    <span class="dt">row_order =</span> <span class="kw">get_order</span>(o, <span class="dv">1</span>), <span class="dt">column_order =</span> <span class="kw">get_order</span>(o, <span class="dv">2</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-28-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Or you can apply <code>seriate()</code> to the distance matrix. Now the order for rows
and columns needs to be calcualted separatedly because the distance matrix
needs to be calculated separatedly for columns and rows.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="a-single-heatmap.html#cb51-1"></a>o1 =<span class="st"> </span><span class="kw">seriate</span>(<span class="kw">dist</span>(mat), <span class="dt">method =</span> <span class="st">&quot;TSP&quot;</span>)</span>
<span id="cb51-2"><a href="a-single-heatmap.html#cb51-2"></a>o2 =<span class="st"> </span><span class="kw">seriate</span>(<span class="kw">dist</span>(<span class="kw">t</span>(mat)), <span class="dt">method =</span> <span class="st">&quot;TSP&quot;</span>)</span>
<span id="cb51-3"><a href="a-single-heatmap.html#cb51-3"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_order =</span> <span class="kw">get_order</span>(o1), <span class="dt">column_order =</span> <span class="kw">get_order</span>(o2))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-29-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Some seriation methods also contain the hierarchical clustering information.
Let’s try:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="a-single-heatmap.html#cb52-1"></a>o1 =<span class="st"> </span><span class="kw">seriate</span>(<span class="kw">dist</span>(mat), <span class="dt">method =</span> <span class="st">&quot;GW&quot;</span>)</span>
<span id="cb52-2"><a href="a-single-heatmap.html#cb52-2"></a>o2 =<span class="st"> </span><span class="kw">seriate</span>(<span class="kw">dist</span>(<span class="kw">t</span>(mat)), <span class="dt">method =</span> <span class="st">&quot;GW&quot;</span>)</span></code></pre></div>
<p><code>o1</code> and <code>o2</code> are actually mainly composed of <code>hclust</code> objects:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="a-single-heatmap.html#cb53-1"></a><span class="kw">class</span>(o1[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;ser_permutation_vector&quot; &quot;hclust&quot;</code></pre>
<p>And the orders are the same by using <code>hclust$order</code> or <code>get_order()</code>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="a-single-heatmap.html#cb55-1"></a>o1[[<span class="dv">1</span>]]<span class="op">$</span>order</span></code></pre></div>
<pre><code>##  [1]  5  2 10 17  4 16 18  7 15 14 11  8  1  3 12  6 13  9</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="a-single-heatmap.html#cb57-1"></a><span class="co"># should be the same as the previous one</span></span>
<span id="cb57-2"><a href="a-single-heatmap.html#cb57-2"></a><span class="kw">get_order</span>(o1)</span></code></pre></div>
<pre><code>##  [1]  5  2 10 17  4 16 18  7 15 14 11  8  1  3 12  6 13  9</code></pre>
<p>And we can add the dendrograms to the heatmap.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="a-single-heatmap.html#cb59-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> <span class="kw">as.dendrogram</span>(o1[[<span class="dv">1</span>]]), </span>
<span id="cb59-2"><a href="a-single-heatmap.html#cb59-2"></a>    <span class="dt">cluster_columns =</span> <span class="kw">as.dendrogram</span>(o2[[<span class="dv">1</span>]]))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>For more use of the <code>seriate()</code> function, please refer to the <a href="https://cran.r-project.org/web/packages/seriation/index.html"><strong>seriation</strong>
package</a>.</p>
</div>
<div id="dimension-names" class="section level2" number="2.6">
<h2><span class="header-section-number">2.6</span> Dimension names</h2>
<p>The row names and column names are drawn on the right and bottom sides of the
heatmap by default. Side, visibility and graphic parameters for dimension
names can be set as follows:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="a-single-heatmap.html#cb60-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_names_side =</span> <span class="st">&quot;left&quot;</span>, <span class="dt">row_dend_side =</span> <span class="st">&quot;right&quot;</span>, </span>
<span id="cb60-2"><a href="a-single-heatmap.html#cb60-2"></a>    <span class="dt">column_names_side =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">column_dend_side =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/dimension_name-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="a-single-heatmap.html#cb61-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/dimension_name-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="a-single-heatmap.html#cb62-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_names_gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">20</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/dimension_name-3.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="a-single-heatmap.html#cb63-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_names_gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;red&quot;</span>, <span class="dv">10</span>), <span class="kw">rep</span>(<span class="st">&quot;blue&quot;</span>, <span class="dv">8</span>))))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/dimension_name-4.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="a-single-heatmap.html#cb64-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_names_centered =</span> <span class="ot">TRUE</span>, <span class="dt">column_names_centered =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/dimension_name-5.png" width="672" style="display: block; margin: auto;" /></p>
<p>The rotation of column names can be set by <code>column_names_rot</code>:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="a-single-heatmap.html#cb65-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_names_rot =</span> <span class="dv">45</span>)</span>
<span id="cb65-2"><a href="a-single-heatmap.html#cb65-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_names_rot =</span> <span class="dv">45</span>, <span class="dt">column_names_side =</span> <span class="st">&quot;top&quot;</span>,</span>
<span id="cb65-3"><a href="a-single-heatmap.html#cb65-3"></a>    <span class="dt">column_dend_side =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-35-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>If you have row names or column names which are too long,
<code>row_names_max_width</code> or <code>column_names_max_height</code> can be used to set the
maximal space for them. The default maximal space for row names and column
names are all 6 cm. In following code, <code>max_text_width()</code> is a helper function
to quick calculate maximal width from a vector of text.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="a-single-heatmap.html#cb66-1"></a>mat2 =<span class="st"> </span>mat</span>
<span id="cb66-2"><a href="a-single-heatmap.html#cb66-2"></a><span class="kw">rownames</span>(mat2)[<span class="dv">1</span>] =<span class="st"> </span><span class="kw">paste</span>(<span class="kw">c</span>(letters, LETTERS), <span class="dt">collapse =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb66-3"><a href="a-single-heatmap.html#cb66-3"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>)</span>
<span id="cb66-4"><a href="a-single-heatmap.html#cb66-4"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb66-5"><a href="a-single-heatmap.html#cb66-5"></a>    <span class="dt">row_names_max_width =</span> <span class="kw">max_text_width</span>(</span>
<span id="cb66-6"><a href="a-single-heatmap.html#cb66-6"></a>        <span class="kw">rownames</span>(mat2), </span>
<span id="cb66-7"><a href="a-single-heatmap.html#cb66-7"></a>        <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">12</span>)</span>
<span id="cb66-8"><a href="a-single-heatmap.html#cb66-8"></a>    ))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-37-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Instead of directly using the row/column names from the matrix, you can also
provide another character vector which corresponds to the rows or columns and
set it by <code>row_labels</code> or <code>column_labels</code>. This is useful because you don’t
need to change the dimension names of the matrix to change the labels on the
heatmap while you can directly provide the new labels.</p>
<p>There is one typical scenario that <code>row_labels</code> and <code>column_labels</code> are
useful. For the gene expression analysis, we might use Ensembl ID as the gene
ID which is used as row names of the gene expression matrix. However, the
Ensembl ID is for the indexing of the Ensembl database but not for the human
reading. Instead, we would prefer to put gene symbols on the heatmap as the
row names which is easier to read. To do this, we only need to assign the
corresponding gene symbols to <code>row_labels</code> without modifying the original
matrix.</p>
<p>The second advantage is <code>row_labels</code> or <code>column_labels</code> allows duplicated
labels, while duplicated row names or column names are not allowed in the
matrix.</p>
<p>Following gives a simple example that we put letters as row labels and column
labels:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="a-single-heatmap.html#cb67-1"></a><span class="co"># use a named vector to make sure the correspondance between </span></span>
<span id="cb67-2"><a href="a-single-heatmap.html#cb67-2"></a><span class="co"># row names and row labels is correct</span></span>
<span id="cb67-3"><a href="a-single-heatmap.html#cb67-3"></a>row_labels =<span class="st"> </span><span class="kw">structure</span>(<span class="kw">paste0</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">24</span>], <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>), <span class="dt">names =</span> <span class="kw">paste0</span>(<span class="st">&quot;row&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>))</span>
<span id="cb67-4"><a href="a-single-heatmap.html#cb67-4"></a>column_labels =<span class="st"> </span><span class="kw">structure</span>(<span class="kw">paste0</span>(LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">24</span>], <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>), <span class="dt">names =</span> <span class="kw">paste0</span>(<span class="st">&quot;column&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>))</span>
<span id="cb67-5"><a href="a-single-heatmap.html#cb67-5"></a>row_labels</span></code></pre></div>
<pre><code>##  row1  row2  row3  row4  row5  row6  row7  row8  row9 row10 row11 row12 row13 
##  &quot;a1&quot;  &quot;b2&quot;  &quot;c3&quot;  &quot;d4&quot;  &quot;e5&quot;  &quot;f6&quot;  &quot;g7&quot;  &quot;h8&quot;  &quot;i9&quot; &quot;j10&quot; &quot;k11&quot; &quot;l12&quot; &quot;m13&quot; 
## row14 row15 row16 row17 row18 row19 row20 row21 row22 row23 row24 
## &quot;n14&quot; &quot;o15&quot; &quot;p16&quot; &quot;q17&quot; &quot;r18&quot; &quot;s19&quot; &quot;t20&quot; &quot;u21&quot; &quot;v22&quot; &quot;w23&quot; &quot;x24&quot;</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="a-single-heatmap.html#cb69-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_labels =</span> row_labels[<span class="kw">rownames</span>(mat)], </span>
<span id="cb69-2"><a href="a-single-heatmap.html#cb69-2"></a>    <span class="dt">column_labels =</span> column_labels[<span class="kw">colnames</span>(mat)])</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-38-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The third advantage is mathematical expression can be used as row names in the
heatmap.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="a-single-heatmap.html#cb70-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_labels =</span> <span class="kw">expression</span>(alpha, beta, gamma, delta, epsilon, </span>
<span id="cb70-2"><a href="a-single-heatmap.html#cb70-2"></a>    zeta, eta, theta, iota, kappa, lambda, mu, nu, xi, omicron, pi, rho, sigma))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-39-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><code>anno_text()</code> (Section <a href="heatmap-annotations.html#text-annotation">3.14</a>) can be used to add more customized
labels for heatmap rows and columns.</p>
</div>
<div id="heatmap-split" class="section level2" number="2.7">
<h2><span class="header-section-number">2.7</span> Heatmap split</h2>
<p>One major advantage of <strong>ComplexHeatmap</strong> package is it supports splitting the
heatmap by rows and columns to better group the features and additionally
highlight the patterns.</p>
<p>Following arguments control the splitting: <code>row_km</code>, <code>row_split</code>, <code>column_km</code>,
<code>column_split</code>. In following, we call the sub-clusters generated by splitting
“<em>slices</em>”.</p>
<div id="split-by-kmeans-clustering" class="section level3" number="2.7.1">
<h3><span class="header-section-number">2.7.1</span> Split by k-means clustering</h3>
<p><code>row_km</code> and <code>column_km</code> apply k-means partitioning.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="a-single-heatmap.html#cb71-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/k_means-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="a-single-heatmap.html#cb72-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">column_km =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/k_means-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>Row splitting and column splitting can be performed simultaneously.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="a-single-heatmap.html#cb73-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-40-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>You might notice there are dashed lines in the row and column dendrograms,
it will be explained in Section <a href="a-single-heatmap.html#split-by-categorical-variables">2.7.2</a> (last paragraph).</p>
<p><code>Heatmap()</code> internally calls <code>kmeans()</code> with random start points, which
results in, for some cases, generating different clusters from repeated runs.
To get rid of this problem, <code>row_km_repeats</code> and <code>column_km_repeats</code> can be
set to a number larger than 1 to run <code>kmeans()</code> multiple times and a final
consensus k-means clustering is used. Please note the final number of clusters
form consensus k-means might be smaller than the number set in <code>row_km</code> and
<code>column_km</code>.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="a-single-heatmap.html#cb74-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb74-2"><a href="a-single-heatmap.html#cb74-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">row_km_repeats =</span> <span class="dv">100</span>,</span>
<span id="cb74-3"><a href="a-single-heatmap.html#cb74-3"></a>    <span class="dt">column_km =</span> <span class="dv">3</span>, <span class="dt">column_km_repeats =</span> <span class="dv">100</span>)</span></code></pre></div>
</div>
<div id="split-by-categorical-variables" class="section level3" number="2.7.2">
<h3><span class="header-section-number">2.7.2</span> Split by categorical variables</h3>
<p>More generally, <code>row_split</code> or <code>column_split</code> can be set to a categorical
vector or a data frame where different combinations of levels split the
rows/columns in the heatmap. How to control the order of the slices is
introduced in Section <a href="a-single-heatmap.html#order-of-slices">2.7.4</a>.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="a-single-heatmap.html#cb75-1"></a><span class="co"># split by a vector</span></span>
<span id="cb75-2"><a href="a-single-heatmap.html#cb75-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb75-3"><a href="a-single-heatmap.html#cb75-3"></a>    <span class="dt">row_split =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dv">9</span>), <span class="dt">column_split =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;C&quot;</span>, <span class="st">&quot;D&quot;</span>), <span class="dv">12</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="a-single-heatmap.html#cb76-1"></a><span class="co"># split by a data frame</span></span>
<span id="cb76-2"><a href="a-single-heatmap.html#cb76-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb76-3"><a href="a-single-heatmap.html#cb76-3"></a>    <span class="dt">row_split =</span> <span class="kw">data.frame</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dv">9</span>), <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;C&quot;</span>, <span class="st">&quot;D&quot;</span>), <span class="dt">each =</span> <span class="dv">9</span>)))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="a-single-heatmap.html#cb77-1"></a><span class="co"># split on both dimensions</span></span>
<span id="cb77-2"><a href="a-single-heatmap.html#cb77-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dv">9</span>)),</span>
<span id="cb77-3"><a href="a-single-heatmap.html#cb77-3"></a>    <span class="dt">column_split =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;C&quot;</span>, <span class="st">&quot;D&quot;</span>), <span class="dv">12</span>)))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split-3.png" width="672" style="display: block; margin: auto;" /></p>
<p>Actually, k-means clustering just generates a vector of cluster classes and
appends to <code>row_split</code> or <code>column_split</code>. <code>row_km</code>/<code>column_km</code> and be used
mixed with <code>row_split</code> and <code>column_split</code>.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="a-single-heatmap.html#cb78-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dv">9</span>), <span class="dt">row_km =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-42-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>which is the same as:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="a-single-heatmap.html#cb79-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb79-2"><a href="a-single-heatmap.html#cb79-2"></a>cl =<span class="st"> </span><span class="kw">kmeans</span>(mat, <span class="dt">centers =</span> <span class="dv">2</span>)<span class="op">$</span>cluster</span>
<span id="cb79-3"><a href="a-single-heatmap.html#cb79-3"></a><span class="co"># classes from k-means are always put as the first column in `row_split`</span></span>
<span id="cb79-4"><a href="a-single-heatmap.html#cb79-4"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> <span class="kw">cbind</span>(cl, <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dv">9</span>)))</span></code></pre></div>
<p>If you are not happy with the default k-means partition, it is easy to use
other partition methods by just assigning the partition vector to
<code>row_split</code>/<code>column_split</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="a-single-heatmap.html#cb80-1"></a>pa =<span class="st"> </span>cluster<span class="op">::</span><span class="kw">pam</span>(mat, <span class="dt">k =</span> <span class="dv">3</span>)</span>
<span id="cb80-2"><a href="a-single-heatmap.html#cb80-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> <span class="kw">paste0</span>(<span class="st">&quot;pam&quot;</span>, pa<span class="op">$</span>clustering))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/pam-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If <code>row_order</code> or <code>column_order</code> is set, in each row/column slice, it is still
ordered.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="a-single-heatmap.html#cb81-1"></a><span class="co"># remember when `row_order` is set, row clustering is turned off</span></span>
<span id="cb81-2"><a href="a-single-heatmap.html#cb81-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_order =</span> <span class="dv">18</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">row_km =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_row_order-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Character matrix can only be split by <code>row_split</code>/<code>column_split</code> argument.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="a-single-heatmap.html#cb82-1"></a><span class="co"># split by the first column in `discrete_mat`</span></span>
<span id="cb82-2"><a href="a-single-heatmap.html#cb82-2"></a><span class="kw">Heatmap</span>(discrete_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">row_split =</span> discrete_mat[, <span class="dv">1</span>])</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_discrete_matrix-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If <code>row_km</code>/<code>column_km</code> is set or <code>row_split</code>/<code>column_split</code> is set as a
vector or a data frame, hierarchical clustering is first applied to each slice
(of course, clustering should be turned on) which generates <code>k</code> dendrograms,
then a parent dendrogram is generated based on the mean values of each slice.
<strong>The height of the parent dendrogram is adjusted by adding the maximal height
of the dendrograms in all children slices and the parent dendrogram is added
on top of the children dendrograms to form a single global dendrogram.</strong> This
is why you see dashed lines in the dendrograms in previous heatmaps. They are
used to mark the parent dendrogram and the children dendrograms, and alert
users they are calculated in different ways. These dashed lines can be removed
by setting <code>show_parent_dend_line = FALSE</code> in <code>Heatmap()</code>, or set it as a
global option: <code>ht_opt$show_parent_dend_line = FALSE</code>.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="a-single-heatmap.html#cb83-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">3</span>, <span class="dt">show_parent_dend_line =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-44-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="spilt-by-dendrogram" class="section level3" number="2.7.3">
<h3><span class="header-section-number">2.7.3</span> Split by dendrogram</h3>
<p>A second scenario for splitting is that users may still want to keep the
global dendrogram <strong>which is generated from the complete matrix</strong> while not
split it in the first place. In this case, <code>row_split</code>/<code>column_split</code> can be
set to a single number which will apply <code>cutree()</code> on the row/column
dendrogram. This works when <code>cluster_rows</code>/<code>cluster_columns</code> is set to <code>TRUE</code>
or is assigned with a <code>hclust</code>/<code>dendrogram</code> object.</p>
<p>For this case, the dendrogram is still as same as the original one, expect the
positions of dendrogram leaves are slightly adjusted by the gaps between
slices. (There is no dashed lines, because here the dendrogram is calcualted
as a complete one and there is no parent dendrogram or children dendrograms.)</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="a-single-heatmap.html#cb84-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> <span class="dv">2</span>, <span class="dt">column_split =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_dendrogram-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre><code>## Called from: make_cluster(object, &quot;row&quot;)
## debug: if (which == &quot;row&quot;) {
##     reorder = -rowMeans(mat, na.rm = TRUE)
## } else {
##     reorder = -colMeans(mat, na.rm = TRUE)
## }
## debug: reorder = -rowMeans(mat, na.rm = TRUE)
## debug: if (do_reorder) {
##     if (which == &quot;row&quot;) {
##         if (length(reorder) != nrow(mat)) {
##             stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
##         }
##     }
##     else {
##         if (length(reorder) != ncol(mat)) {
##             stop_wrap(&quot;weight of reordering should have same length as number of columns\n&quot;)
##         }
##     }
##     for (i in seq_along(dend_list)) {
##         if (length(order_list[[i]]) &gt; 1) {
##             sub_ind = sort(order_list[[i]])
##             dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##                 mean)
##             order_list[[i]] = order.dendrogram(dend_list[[i]])
##         }
##     }
## }
## debug: if (which == &quot;row&quot;) {
##     if (length(reorder) != nrow(mat)) {
##         stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
##     }
## } else {
##     if (length(reorder) != ncol(mat)) {
##         stop_wrap(&quot;weight of reordering should have same length as number of columns\n&quot;)
##     }
## }
## debug: if (length(reorder) != nrow(mat)) {
##     stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
## }
## debug: for (i in seq_along(dend_list)) {
##     if (length(order_list[[i]]) &gt; 1) {
##         sub_ind = sort(order_list[[i]])
##         dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##             mean)
##         order_list[[i]] = order.dendrogram(dend_list[[i]])
##     }
## }
## debug: if (length(order_list[[i]]) &gt; 1) {
##     sub_ind = sort(order_list[[i]])
##     dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##         mean)
##     order_list[[i]] = order.dendrogram(dend_list[[i]])
## }
## debug: sub_ind = sort(order_list[[i]])
## debug: dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], mean)
## debug: order_list[[i]] = order.dendrogram(dend_list[[i]])
## debug: if (length(order_list[[i]]) &gt; 1) {
##     sub_ind = sort(order_list[[i]])
##     dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##         mean)
##     order_list[[i]] = order.dendrogram(dend_list[[i]])
## }
## debug: sub_ind = sort(order_list[[i]])
## debug: dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], mean)
## debug: order_list[[i]] = order.dendrogram(dend_list[[i]])
## debug: dend_list = lapply(dend_list, adjust_dend_by_x)
## debug: slot(object, paste0(which, &quot;_order&quot;)) = unlist(order_list)
## debug: slot(object, paste0(which, &quot;_order_list&quot;)) = order_list
## debug: slot(object, paste0(which, &quot;_dend_list&quot;)) = dend_list
## debug: slot(object, paste0(which, &quot;_dend_param&quot;)) = dend_param
## debug: slot(object, paste0(which, &quot;_dend_slice&quot;)) = dend_slice
## debug: if (!is.null(split)) {
##     split = data.frame(rep(seq_along(order_list), times = sapply(order_list, 
##         length)))
##     object@matrix_param[[paste0(which, &quot;_split&quot;)]] = split
##     for (i in seq_along(names_param$gp)) {
##         if (length(names_param$gp[[i]]) == length(order_list)) {
##             gp_temp = NULL
##             for (j in seq_along(order_list)) {
##                 gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##             }
##             names_param$gp[[i]] = gp_temp
##         }
##     }
##     if (!is.null(names_param$anno)) {
##         names_param$anno@var_env$gp = names_param$gp
##     }
##     slot(object, paste0(which, &quot;_names_param&quot;)) = names_param
##     n_slice = length(order_list)
##     if (length(gap) == 1) {
##         gap = rep(gap, n_slice)
##     }
##     else if (length(gap) == n_slice - 1) {
##         gap = unit.c(gap, unit(0, &quot;mm&quot;))
##     }
##     else if (length(gap) != n_slice) {
##         stop_wrap(qq(&quot;Length of `gap` should be 1 or number of @{which} slices.&quot;))
##     }
##     object@matrix_param[[paste0(which, &quot;_gap&quot;)]] = gap
##     title = slot(object, paste0(which, &quot;_title&quot;))
##     if (!is.null(split)) {
##         if (length(title) == 0 &amp;&amp; !is.null(title)) {
##             title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
##         }
##         else if (length(title) == 1) {
##             if (grepl(&quot;%s&quot;, title)) {
##                 title = apply(unique(split), 1, function(x) {
##                   lt = lapply(x, function(x) x)
##                   lt$fmt = title
##                   do.call(sprintf, lt)
##                 })
##             }
##             else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##                 title = apply(unique(split), 1, function(x) {
##                   x = x
##                   envir = environment()
##                   title = get(&quot;title&quot;)
##                   op = parent.env(envir)
##                   calling_env = object@heatmap_param$calling_env
##                   parent.env(envir) = calling_env
##                   title = GetoptLong::qq(title, envir = envir)
##                   parent.env(envir) = op
##                   return(title)
##                 })
##             }
##             else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##                 if (!requireNamespace(&quot;glue&quot;)) {
##                   stop_wrap(&quot;You need to install glue package.&quot;)
##                 }
##                 title = apply(unique(split), 1, function(x) {
##                   x = x
##                   envir = environment()
##                   title = get(&quot;title&quot;)
##                   op = parent.env(envir)
##                   calling_env = object@heatmap_param$calling_env
##                   parent.env(envir) = calling_env
##                   title = glue::glue(title, envir = calling_env)
##                   parent.env(envir) = op
##                   return(title)
##                 })
##             }
##         }
##     }
##     slot(object, paste0(which, &quot;_title&quot;)) = title
## }
## debug: split = data.frame(rep(seq_along(order_list), times = sapply(order_list, 
##     length)))
## debug: object@matrix_param[[paste0(which, &quot;_split&quot;)]] = split
## debug: for (i in seq_along(names_param$gp)) {
##     if (length(names_param$gp[[i]]) == length(order_list)) {
##         gp_temp = NULL
##         for (j in seq_along(order_list)) {
##             gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##         }
##         names_param$gp[[i]] = gp_temp
##     }
## }
## debug: if (length(names_param$gp[[i]]) == length(order_list)) {
##     gp_temp = NULL
##     for (j in seq_along(order_list)) {
##         gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##     }
##     names_param$gp[[i]] = gp_temp
## }
## debug: if (!is.null(names_param$anno)) {
##     names_param$anno@var_env$gp = names_param$gp
## }
## debug: names_param$anno@var_env$gp = names_param$gp
## debug: slot(object, paste0(which, &quot;_names_param&quot;)) = names_param
## debug: n_slice = length(order_list)
## debug: if (length(gap) == 1) {
##     gap = rep(gap, n_slice)
## } else if (length(gap) == n_slice - 1) {
##     gap = unit.c(gap, unit(0, &quot;mm&quot;))
## } else if (length(gap) != n_slice) {
##     stop_wrap(qq(&quot;Length of `gap` should be 1 or number of @{which} slices.&quot;))
## }
## debug: gap = rep(gap, n_slice)
## debug: object@matrix_param[[paste0(which, &quot;_gap&quot;)]] = gap
## debug: title = slot(object, paste0(which, &quot;_title&quot;))
## debug: if (!is.null(split)) {
##     if (length(title) == 0 &amp;&amp; !is.null(title)) {
##         title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
##     }
##     else if (length(title) == 1) {
##         if (grepl(&quot;%s&quot;, title)) {
##             title = apply(unique(split), 1, function(x) {
##                 lt = lapply(x, function(x) x)
##                 lt$fmt = title
##                 do.call(sprintf, lt)
##             })
##         }
##         else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##             title = apply(unique(split), 1, function(x) {
##                 x = x
##                 envir = environment()
##                 title = get(&quot;title&quot;)
##                 op = parent.env(envir)
##                 calling_env = object@heatmap_param$calling_env
##                 parent.env(envir) = calling_env
##                 title = GetoptLong::qq(title, envir = envir)
##                 parent.env(envir) = op
##                 return(title)
##             })
##         }
##         else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##             if (!requireNamespace(&quot;glue&quot;)) {
##                 stop_wrap(&quot;You need to install glue package.&quot;)
##             }
##             title = apply(unique(split), 1, function(x) {
##                 x = x
##                 envir = environment()
##                 title = get(&quot;title&quot;)
##                 op = parent.env(envir)
##                 calling_env = object@heatmap_param$calling_env
##                 parent.env(envir) = calling_env
##                 title = glue::glue(title, envir = calling_env)
##                 parent.env(envir) = op
##                 return(title)
##             })
##         }
##     }
## }
## debug: if (length(title) == 0 &amp;&amp; !is.null(title)) {
##     title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
## } else if (length(title) == 1) {
##     if (grepl(&quot;%s&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             lt = lapply(x, function(x) x)
##             lt$fmt = title
##             do.call(sprintf, lt)
##         })
##     }
##     else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = GetoptLong::qq(title, envir = envir)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
##     else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##         if (!requireNamespace(&quot;glue&quot;)) {
##             stop_wrap(&quot;You need to install glue package.&quot;)
##         }
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = glue::glue(title, envir = calling_env)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
## }
## debug: title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
## debug: slot(object, paste0(which, &quot;_title&quot;)) = title
## debug: return(object)
## Called from: make_cluster(object, &quot;column&quot;)
## debug: if (which == &quot;row&quot;) {
##     reorder = -rowMeans(mat, na.rm = TRUE)
## } else {
##     reorder = -colMeans(mat, na.rm = TRUE)
## }
## debug: reorder = -colMeans(mat, na.rm = TRUE)
## debug: if (do_reorder) {
##     if (which == &quot;row&quot;) {
##         if (length(reorder) != nrow(mat)) {
##             stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
##         }
##     }
##     else {
##         if (length(reorder) != ncol(mat)) {
##             stop_wrap(&quot;weight of reordering should have same length as number of columns\n&quot;)
##         }
##     }
##     for (i in seq_along(dend_list)) {
##         if (length(order_list[[i]]) &gt; 1) {
##             sub_ind = sort(order_list[[i]])
##             dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##                 mean)
##             order_list[[i]] = order.dendrogram(dend_list[[i]])
##         }
##     }
## }
## debug: if (which == &quot;row&quot;) {
##     if (length(reorder) != nrow(mat)) {
##         stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
##     }
## } else {
##     if (length(reorder) != ncol(mat)) {
##         stop_wrap(&quot;weight of reordering should have same length as number of columns\n&quot;)
##     }
## }
## debug: if (length(reorder) != ncol(mat)) {
##     stop_wrap(&quot;weight of reordering should have same length as number of columns\n&quot;)
## }
## debug: for (i in seq_along(dend_list)) {
##     if (length(order_list[[i]]) &gt; 1) {
##         sub_ind = sort(order_list[[i]])
##         dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##             mean)
##         order_list[[i]] = order.dendrogram(dend_list[[i]])
##     }
## }
## debug: if (length(order_list[[i]]) &gt; 1) {
##     sub_ind = sort(order_list[[i]])
##     dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##         mean)
##     order_list[[i]] = order.dendrogram(dend_list[[i]])
## }
## debug: sub_ind = sort(order_list[[i]])
## debug: dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], mean)
## debug: order_list[[i]] = order.dendrogram(dend_list[[i]])
## debug: if (length(order_list[[i]]) &gt; 1) {
##     sub_ind = sort(order_list[[i]])
##     dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##         mean)
##     order_list[[i]] = order.dendrogram(dend_list[[i]])
## }
## debug: sub_ind = sort(order_list[[i]])
## debug: dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], mean)
## debug: order_list[[i]] = order.dendrogram(dend_list[[i]])
## debug: if (length(order_list[[i]]) &gt; 1) {
##     sub_ind = sort(order_list[[i]])
##     dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##         mean)
##     order_list[[i]] = order.dendrogram(dend_list[[i]])
## }
## debug: sub_ind = sort(order_list[[i]])
## debug: dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], mean)
## debug: order_list[[i]] = order.dendrogram(dend_list[[i]])
## debug: dend_list = lapply(dend_list, adjust_dend_by_x)
## debug: slot(object, paste0(which, &quot;_order&quot;)) = unlist(order_list)
## debug: slot(object, paste0(which, &quot;_order_list&quot;)) = order_list
## debug: slot(object, paste0(which, &quot;_dend_list&quot;)) = dend_list
## debug: slot(object, paste0(which, &quot;_dend_param&quot;)) = dend_param
## debug: slot(object, paste0(which, &quot;_dend_slice&quot;)) = dend_slice
## debug: if (!is.null(split)) {
##     split = data.frame(rep(seq_along(order_list), times = sapply(order_list, 
##         length)))
##     object@matrix_param[[paste0(which, &quot;_split&quot;)]] = split
##     for (i in seq_along(names_param$gp)) {
##         if (length(names_param$gp[[i]]) == length(order_list)) {
##             gp_temp = NULL
##             for (j in seq_along(order_list)) {
##                 gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##             }
##             names_param$gp[[i]] = gp_temp
##         }
##     }
##     if (!is.null(names_param$anno)) {
##         names_param$anno@var_env$gp = names_param$gp
##     }
##     slot(object, paste0(which, &quot;_names_param&quot;)) = names_param
##     n_slice = length(order_list)
##     if (length(gap) == 1) {
##         gap = rep(gap, n_slice)
##     }
##     else if (length(gap) == n_slice - 1) {
##         gap = unit.c(gap, unit(0, &quot;mm&quot;))
##     }
##     else if (length(gap) != n_slice) {
##         stop_wrap(qq(&quot;Length of `gap` should be 1 or number of @{which} slices.&quot;))
##     }
##     object@matrix_param[[paste0(which, &quot;_gap&quot;)]] = gap
##     title = slot(object, paste0(which, &quot;_title&quot;))
##     if (!is.null(split)) {
##         if (length(title) == 0 &amp;&amp; !is.null(title)) {
##             title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
##         }
##         else if (length(title) == 1) {
##             if (grepl(&quot;%s&quot;, title)) {
##                 title = apply(unique(split), 1, function(x) {
##                   lt = lapply(x, function(x) x)
##                   lt$fmt = title
##                   do.call(sprintf, lt)
##                 })
##             }
##             else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##                 title = apply(unique(split), 1, function(x) {
##                   x = x
##                   envir = environment()
##                   title = get(&quot;title&quot;)
##                   op = parent.env(envir)
##                   calling_env = object@heatmap_param$calling_env
##                   parent.env(envir) = calling_env
##                   title = GetoptLong::qq(title, envir = envir)
##                   parent.env(envir) = op
##                   return(title)
##                 })
##             }
##             else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##                 if (!requireNamespace(&quot;glue&quot;)) {
##                   stop_wrap(&quot;You need to install glue package.&quot;)
##                 }
##                 title = apply(unique(split), 1, function(x) {
##                   x = x
##                   envir = environment()
##                   title = get(&quot;title&quot;)
##                   op = parent.env(envir)
##                   calling_env = object@heatmap_param$calling_env
##                   parent.env(envir) = calling_env
##                   title = glue::glue(title, envir = calling_env)
##                   parent.env(envir) = op
##                   return(title)
##                 })
##             }
##         }
##     }
##     slot(object, paste0(which, &quot;_title&quot;)) = title
## }
## debug: split = data.frame(rep(seq_along(order_list), times = sapply(order_list, 
##     length)))
## debug: object@matrix_param[[paste0(which, &quot;_split&quot;)]] = split
## debug: for (i in seq_along(names_param$gp)) {
##     if (length(names_param$gp[[i]]) == length(order_list)) {
##         gp_temp = NULL
##         for (j in seq_along(order_list)) {
##             gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##         }
##         names_param$gp[[i]] = gp_temp
##     }
## }
## debug: if (length(names_param$gp[[i]]) == length(order_list)) {
##     gp_temp = NULL
##     for (j in seq_along(order_list)) {
##         gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##     }
##     names_param$gp[[i]] = gp_temp
## }
## debug: if (!is.null(names_param$anno)) {
##     names_param$anno@var_env$gp = names_param$gp
## }
## debug: names_param$anno@var_env$gp = names_param$gp
## debug: slot(object, paste0(which, &quot;_names_param&quot;)) = names_param
## debug: n_slice = length(order_list)
## debug: if (length(gap) == 1) {
##     gap = rep(gap, n_slice)
## } else if (length(gap) == n_slice - 1) {
##     gap = unit.c(gap, unit(0, &quot;mm&quot;))
## } else if (length(gap) != n_slice) {
##     stop_wrap(qq(&quot;Length of `gap` should be 1 or number of @{which} slices.&quot;))
## }
## debug: gap = rep(gap, n_slice)
## debug: object@matrix_param[[paste0(which, &quot;_gap&quot;)]] = gap
## debug: title = slot(object, paste0(which, &quot;_title&quot;))
## debug: if (!is.null(split)) {
##     if (length(title) == 0 &amp;&amp; !is.null(title)) {
##         title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
##     }
##     else if (length(title) == 1) {
##         if (grepl(&quot;%s&quot;, title)) {
##             title = apply(unique(split), 1, function(x) {
##                 lt = lapply(x, function(x) x)
##                 lt$fmt = title
##                 do.call(sprintf, lt)
##             })
##         }
##         else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##             title = apply(unique(split), 1, function(x) {
##                 x = x
##                 envir = environment()
##                 title = get(&quot;title&quot;)
##                 op = parent.env(envir)
##                 calling_env = object@heatmap_param$calling_env
##                 parent.env(envir) = calling_env
##                 title = GetoptLong::qq(title, envir = envir)
##                 parent.env(envir) = op
##                 return(title)
##             })
##         }
##         else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##             if (!requireNamespace(&quot;glue&quot;)) {
##                 stop_wrap(&quot;You need to install glue package.&quot;)
##             }
##             title = apply(unique(split), 1, function(x) {
##                 x = x
##                 envir = environment()
##                 title = get(&quot;title&quot;)
##                 op = parent.env(envir)
##                 calling_env = object@heatmap_param$calling_env
##                 parent.env(envir) = calling_env
##                 title = glue::glue(title, envir = calling_env)
##                 parent.env(envir) = op
##                 return(title)
##             })
##         }
##     }
## }
## debug: if (length(title) == 0 &amp;&amp; !is.null(title)) {
##     title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
## } else if (length(title) == 1) {
##     if (grepl(&quot;%s&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             lt = lapply(x, function(x) x)
##             lt$fmt = title
##             do.call(sprintf, lt)
##         })
##     }
##     else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = GetoptLong::qq(title, envir = envir)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
##     else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##         if (!requireNamespace(&quot;glue&quot;)) {
##             stop_wrap(&quot;You need to install glue package.&quot;)
##         }
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = glue::glue(title, envir = calling_env)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
## }
## debug: title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
## debug: slot(object, paste0(which, &quot;_title&quot;)) = title
## debug: return(object)</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="a-single-heatmap.html#cb86-1"></a>dend =<span class="st"> </span><span class="kw">hclust</span>(<span class="kw">dist</span>(mat))</span>
<span id="cb86-2"><a href="a-single-heatmap.html#cb86-2"></a>dend =<span class="st"> </span><span class="kw">color_branches</span>(dend, <span class="dt">k =</span> <span class="dv">2</span>)</span>
<span id="cb86-3"><a href="a-single-heatmap.html#cb86-3"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">cluster_rows =</span> dend, <span class="dt">row_split =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_dendrogram-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>If you want to combine splitting from <code>cutree()</code> and other categorical
variables, you need to generate the classes from <code>cutree()</code> in the first
place, append to e.g. <code>row_split</code> as a data frame and then send it to
<code>row_split</code> argument.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="a-single-heatmap.html#cb87-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb87-2"><a href="a-single-heatmap.html#cb87-2"></a>split =<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">cutree</span>(<span class="kw">hclust</span>(<span class="kw">dist</span>(mat)), <span class="dt">k =</span> <span class="dv">2</span>), <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dv">9</span>))</span>
<span id="cb87-3"><a href="a-single-heatmap.html#cb87-3"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split)</span></code></pre></div>
</div>
<div id="order-of-slices" class="section level3" number="2.7.4">
<h3><span class="header-section-number">2.7.4</span> Order of slices</h3>
<p>When <code>row_split</code>/<code>column_split</code> is set as categorical variable (a vector or a
data frame) or <code>row_km</code>/<code>column_km</code> is set, by default, there is an additional
clustering applied to the mean of slices to show the hierarchy in the slice
level. Under this scenario, you cannot precisely control the order of slices
because it is controlled by the clustering of slices.</p>
<p>Nevertheless, you can set <code>cluster_row_slices</code> or <code>cluster_column_slices</code> to
<code>FALSE</code> to turn off the clustering on slices, and now you can precisely
control the order of slices.</p>
<p>When there is no slice clustering, the order of each slice can be controlled
by <code>levels</code> of each variable in <code>row_split</code>/<code>column_split</code> (in this case, each
variable should be a factor). If all variables are characters, the default
order is <code>unique(row_split)</code> or <code>unique(column_split)</code>. Compare following
heatmaps:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="a-single-heatmap.html#cb88-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb88-2"><a href="a-single-heatmap.html#cb88-2"></a>  <span class="dt">row_split =</span> <span class="kw">rep</span>(LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>], <span class="dv">6</span>),</span>
<span id="cb88-3"><a href="a-single-heatmap.html#cb88-3"></a>    <span class="dt">column_split =</span> <span class="kw">rep</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>], <span class="dv">4</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-46-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="a-single-heatmap.html#cb89-1"></a><span class="co"># clustering is similar as previous heatmap with branches in some nodes in the dendrogram flipped</span></span>
<span id="cb89-2"><a href="a-single-heatmap.html#cb89-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb89-3"><a href="a-single-heatmap.html#cb89-3"></a>  <span class="dt">row_split =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>], <span class="dv">6</span>), <span class="dt">levels =</span> LETTERS[<span class="dv">3</span><span class="op">:</span><span class="dv">1</span>]),</span>
<span id="cb89-4"><a href="a-single-heatmap.html#cb89-4"></a>    <span class="dt">column_split =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>], <span class="dv">4</span>), <span class="dt">levels =</span> letters[<span class="dv">6</span><span class="op">:</span><span class="dv">1</span>]))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-46-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="a-single-heatmap.html#cb90-1"></a><span class="co"># now the order is exactly what we set</span></span>
<span id="cb90-2"><a href="a-single-heatmap.html#cb90-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb90-3"><a href="a-single-heatmap.html#cb90-3"></a>  <span class="dt">row_split =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>], <span class="dv">6</span>), <span class="dt">levels =</span> LETTERS[<span class="dv">3</span><span class="op">:</span><span class="dv">1</span>]),</span>
<span id="cb90-4"><a href="a-single-heatmap.html#cb90-4"></a>    <span class="dt">column_split =</span> <span class="kw">factor</span>(<span class="kw">rep</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>], <span class="dv">4</span>), <span class="dt">levels =</span> letters[<span class="dv">6</span><span class="op">:</span><span class="dv">1</span>]),</span>
<span id="cb90-5"><a href="a-single-heatmap.html#cb90-5"></a>    <span class="dt">cluster_row_slices =</span> <span class="ot">FALSE</span>, </span>
<span id="cb90-6"><a href="a-single-heatmap.html#cb90-6"></a>    <span class="dt">cluster_column_slices =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-46-3.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="titles-for-splitting" class="section level3" number="2.7.5">
<h3><span class="header-section-number">2.7.5</span> Titles for splitting</h3>
<p>When <code>row_split</code>/<code>column_split</code> is set as a single number, there is only one
categorical variable, while when <code>row_km</code>/<code>column_km</code> is set and/or
<code>row_split</code>/<code>column_split</code> is set as categorical variables, there will be
multiple categorical variables. By default, the titles are in a form of
<code>"level1,level2,..."</code> which corresponds to every combination of levels in all
categorical variables. The titles for splitting can be controlled by “a title
template”.</p>
<p><strong>ComplexHeatmap</strong> supports three types of templates. The first one is by
<code>sprintf()</code> where the <code>%s</code> is replaced by the corresponding level. In
following example, since all combinations of <code>split</code> are <code>A,C</code>, <code>A,D</code>, <code>B,C</code>
and <code>B,D</code>, if <code>row_title</code> is set to <code>%s|%s</code>, the four row titles will be
<code>A|C</code>, <code>A|D</code>, <code>B|C</code>, <code>B|D</code>.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="a-single-heatmap.html#cb91-1"></a>split =<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>), <span class="dv">9</span>), <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;C&quot;</span>, <span class="st">&quot;D&quot;</span>), <span class="dt">each =</span> <span class="dv">9</span>))</span>
<span id="cb91-2"><a href="a-single-heatmap.html#cb91-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, <span class="dt">row_title =</span> <span class="st">&quot;%s|%s&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-47-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>For the <code>sprintf()</code> template, you can only put the levels which are <code>A,B,C,D</code>
in the title, and <code>C,D</code> is always after <code>A,B</code>. However, when making the
heatmap, you might want to put more meaningful text instead of the internal
levels. Once you know how to correspond the text to the level, you can add it
by following two template methods.</p>
<p>In the following two template methods, special marks are used to mark the R
code which is executable (it is called variable interpolation where the code
is extracted and executed and the returned value in put back to the string).
There are two types of template marks <code>@{}</code> and <code>{}</code>. The first one is from
<strong>GetoptLong</strong> package which should already be installed when you install the
<strong>ComplexHeatmap</strong> package and the second one is from <strong>glue</strong> package which
you need to install first.</p>
<p>There is an internal variable <code>x</code> you should use when you use the latter two
templates. <code>x</code> is just a simple vector which contains current category levels
(e.g. <code>c("A", "C")</code>).</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="a-single-heatmap.html#cb92-1"></a><span class="co"># We only run the code for the first heatmap</span></span>
<span id="cb92-2"><a href="a-single-heatmap.html#cb92-2"></a>map =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span> =<span class="st"> &quot;aaa&quot;</span>, <span class="st">&quot;B&quot;</span> =<span class="st"> &quot;bbb&quot;</span>, <span class="st">&quot;C&quot;</span> =<span class="st"> &quot;333&quot;</span>, <span class="st">&quot;D&quot;</span> =<span class="st"> &quot;444&quot;</span>)</span>
<span id="cb92-3"><a href="a-single-heatmap.html#cb92-3"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, <span class="dt">row_title =</span> <span class="st">&quot;@{map[ x[1] ]}|@{map[ x[2] ]}&quot;</span>)</span>
<span id="cb92-4"><a href="a-single-heatmap.html#cb92-4"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, <span class="dt">row_title =</span> <span class="st">&quot;{map[ x[1] ]}|{map[ x[2] ]}&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-49-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The row title is rotated by default, you can set <code>row_title_rot = 0</code> to make
it horizontal:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="a-single-heatmap.html#cb93-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, <span class="dt">row_title =</span> <span class="st">&quot;%s|%s&quot;</span>, <span class="dt">row_title_rot =</span> <span class="dv">0</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-50-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>When <code>row_split</code>/<code>column_split</code> is set as a number, you can also use template
to adjust the titles for slices.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="a-single-heatmap.html#cb94-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> <span class="dv">2</span>, <span class="dt">row_title =</span> <span class="st">&quot;cluster_%s&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-51-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre><code>## Called from: make_cluster(object, &quot;row&quot;)
## debug: if (which == &quot;row&quot;) {
##     reorder = -rowMeans(mat, na.rm = TRUE)
## } else {
##     reorder = -colMeans(mat, na.rm = TRUE)
## }
## debug: reorder = -rowMeans(mat, na.rm = TRUE)
## debug: if (do_reorder) {
##     if (which == &quot;row&quot;) {
##         if (length(reorder) != nrow(mat)) {
##             stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
##         }
##     }
##     else {
##         if (length(reorder) != ncol(mat)) {
##             stop_wrap(&quot;weight of reordering should have same length as number of columns\n&quot;)
##         }
##     }
##     for (i in seq_along(dend_list)) {
##         if (length(order_list[[i]]) &gt; 1) {
##             sub_ind = sort(order_list[[i]])
##             dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##                 mean)
##             order_list[[i]] = order.dendrogram(dend_list[[i]])
##         }
##     }
## }
## debug: if (which == &quot;row&quot;) {
##     if (length(reorder) != nrow(mat)) {
##         stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
##     }
## } else {
##     if (length(reorder) != ncol(mat)) {
##         stop_wrap(&quot;weight of reordering should have same length as number of columns\n&quot;)
##     }
## }
## debug: if (length(reorder) != nrow(mat)) {
##     stop_wrap(&quot;weight of reordering should have same length as number of rows.\n&quot;)
## }
## debug: for (i in seq_along(dend_list)) {
##     if (length(order_list[[i]]) &gt; 1) {
##         sub_ind = sort(order_list[[i]])
##         dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##             mean)
##         order_list[[i]] = order.dendrogram(dend_list[[i]])
##     }
## }
## debug: if (length(order_list[[i]]) &gt; 1) {
##     sub_ind = sort(order_list[[i]])
##     dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##         mean)
##     order_list[[i]] = order.dendrogram(dend_list[[i]])
## }
## debug: sub_ind = sort(order_list[[i]])
## debug: dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], mean)
## debug: order_list[[i]] = order.dendrogram(dend_list[[i]])
## debug: if (length(order_list[[i]]) &gt; 1) {
##     sub_ind = sort(order_list[[i]])
##     dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], 
##         mean)
##     order_list[[i]] = order.dendrogram(dend_list[[i]])
## }
## debug: sub_ind = sort(order_list[[i]])
## debug: dend_list[[i]] = reorder(dend_list[[i]], reorder[sub_ind], mean)
## debug: order_list[[i]] = order.dendrogram(dend_list[[i]])
## debug: dend_list = lapply(dend_list, adjust_dend_by_x)
## debug: slot(object, paste0(which, &quot;_order&quot;)) = unlist(order_list)
## debug: slot(object, paste0(which, &quot;_order_list&quot;)) = order_list
## debug: slot(object, paste0(which, &quot;_dend_list&quot;)) = dend_list
## debug: slot(object, paste0(which, &quot;_dend_param&quot;)) = dend_param
## debug: slot(object, paste0(which, &quot;_dend_slice&quot;)) = dend_slice
## debug: if (!is.null(split)) {
##     split = data.frame(rep(seq_along(order_list), times = sapply(order_list, 
##         length)))
##     object@matrix_param[[paste0(which, &quot;_split&quot;)]] = split
##     for (i in seq_along(names_param$gp)) {
##         if (length(names_param$gp[[i]]) == length(order_list)) {
##             gp_temp = NULL
##             for (j in seq_along(order_list)) {
##                 gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##             }
##             names_param$gp[[i]] = gp_temp
##         }
##     }
##     if (!is.null(names_param$anno)) {
##         names_param$anno@var_env$gp = names_param$gp
##     }
##     slot(object, paste0(which, &quot;_names_param&quot;)) = names_param
##     n_slice = length(order_list)
##     if (length(gap) == 1) {
##         gap = rep(gap, n_slice)
##     }
##     else if (length(gap) == n_slice - 1) {
##         gap = unit.c(gap, unit(0, &quot;mm&quot;))
##     }
##     else if (length(gap) != n_slice) {
##         stop_wrap(qq(&quot;Length of `gap` should be 1 or number of @{which} slices.&quot;))
##     }
##     object@matrix_param[[paste0(which, &quot;_gap&quot;)]] = gap
##     title = slot(object, paste0(which, &quot;_title&quot;))
##     if (!is.null(split)) {
##         if (length(title) == 0 &amp;&amp; !is.null(title)) {
##             title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
##         }
##         else if (length(title) == 1) {
##             if (grepl(&quot;%s&quot;, title)) {
##                 title = apply(unique(split), 1, function(x) {
##                   lt = lapply(x, function(x) x)
##                   lt$fmt = title
##                   do.call(sprintf, lt)
##                 })
##             }
##             else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##                 title = apply(unique(split), 1, function(x) {
##                   x = x
##                   envir = environment()
##                   title = get(&quot;title&quot;)
##                   op = parent.env(envir)
##                   calling_env = object@heatmap_param$calling_env
##                   parent.env(envir) = calling_env
##                   title = GetoptLong::qq(title, envir = envir)
##                   parent.env(envir) = op
##                   return(title)
##                 })
##             }
##             else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##                 if (!requireNamespace(&quot;glue&quot;)) {
##                   stop_wrap(&quot;You need to install glue package.&quot;)
##                 }
##                 title = apply(unique(split), 1, function(x) {
##                   x = x
##                   envir = environment()
##                   title = get(&quot;title&quot;)
##                   op = parent.env(envir)
##                   calling_env = object@heatmap_param$calling_env
##                   parent.env(envir) = calling_env
##                   title = glue::glue(title, envir = calling_env)
##                   parent.env(envir) = op
##                   return(title)
##                 })
##             }
##         }
##     }
##     slot(object, paste0(which, &quot;_title&quot;)) = title
## }
## debug: split = data.frame(rep(seq_along(order_list), times = sapply(order_list, 
##     length)))
## debug: object@matrix_param[[paste0(which, &quot;_split&quot;)]] = split
## debug: for (i in seq_along(names_param$gp)) {
##     if (length(names_param$gp[[i]]) == length(order_list)) {
##         gp_temp = NULL
##         for (j in seq_along(order_list)) {
##             gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##         }
##         names_param$gp[[i]] = gp_temp
##     }
## }
## debug: if (length(names_param$gp[[i]]) == length(order_list)) {
##     gp_temp = NULL
##     for (j in seq_along(order_list)) {
##         gp_temp[order_list[[j]]] = names_param$gp[[i]][j]
##     }
##     names_param$gp[[i]] = gp_temp
## }
## debug: if (!is.null(names_param$anno)) {
##     names_param$anno@var_env$gp = names_param$gp
## }
## debug: names_param$anno@var_env$gp = names_param$gp
## debug: slot(object, paste0(which, &quot;_names_param&quot;)) = names_param
## debug: n_slice = length(order_list)
## debug: if (length(gap) == 1) {
##     gap = rep(gap, n_slice)
## } else if (length(gap) == n_slice - 1) {
##     gap = unit.c(gap, unit(0, &quot;mm&quot;))
## } else if (length(gap) != n_slice) {
##     stop_wrap(qq(&quot;Length of `gap` should be 1 or number of @{which} slices.&quot;))
## }
## debug: gap = rep(gap, n_slice)
## debug: object@matrix_param[[paste0(which, &quot;_gap&quot;)]] = gap
## debug: title = slot(object, paste0(which, &quot;_title&quot;))
## debug: if (!is.null(split)) {
##     if (length(title) == 0 &amp;&amp; !is.null(title)) {
##         title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
##     }
##     else if (length(title) == 1) {
##         if (grepl(&quot;%s&quot;, title)) {
##             title = apply(unique(split), 1, function(x) {
##                 lt = lapply(x, function(x) x)
##                 lt$fmt = title
##                 do.call(sprintf, lt)
##             })
##         }
##         else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##             title = apply(unique(split), 1, function(x) {
##                 x = x
##                 envir = environment()
##                 title = get(&quot;title&quot;)
##                 op = parent.env(envir)
##                 calling_env = object@heatmap_param$calling_env
##                 parent.env(envir) = calling_env
##                 title = GetoptLong::qq(title, envir = envir)
##                 parent.env(envir) = op
##                 return(title)
##             })
##         }
##         else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##             if (!requireNamespace(&quot;glue&quot;)) {
##                 stop_wrap(&quot;You need to install glue package.&quot;)
##             }
##             title = apply(unique(split), 1, function(x) {
##                 x = x
##                 envir = environment()
##                 title = get(&quot;title&quot;)
##                 op = parent.env(envir)
##                 calling_env = object@heatmap_param$calling_env
##                 parent.env(envir) = calling_env
##                 title = glue::glue(title, envir = calling_env)
##                 parent.env(envir) = op
##                 return(title)
##             })
##         }
##     }
## }
## debug: if (length(title) == 0 &amp;&amp; !is.null(title)) {
##     title = apply(unique(split), 1, paste, collapse = &quot;,&quot;)
## } else if (length(title) == 1) {
##     if (grepl(&quot;%s&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             lt = lapply(x, function(x) x)
##             lt$fmt = title
##             do.call(sprintf, lt)
##         })
##     }
##     else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = GetoptLong::qq(title, envir = envir)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
##     else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##         if (!requireNamespace(&quot;glue&quot;)) {
##             stop_wrap(&quot;You need to install glue package.&quot;)
##         }
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = glue::glue(title, envir = calling_env)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
## }
## debug: if (length(title) == 1) {
##     if (grepl(&quot;%s&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             lt = lapply(x, function(x) x)
##             lt$fmt = title
##             do.call(sprintf, lt)
##         })
##     }
##     else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = GetoptLong::qq(title, envir = envir)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
##     else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##         if (!requireNamespace(&quot;glue&quot;)) {
##             stop_wrap(&quot;You need to install glue package.&quot;)
##         }
##         title = apply(unique(split), 1, function(x) {
##             x = x
##             envir = environment()
##             title = get(&quot;title&quot;)
##             op = parent.env(envir)
##             calling_env = object@heatmap_param$calling_env
##             parent.env(envir) = calling_env
##             title = glue::glue(title, envir = calling_env)
##             parent.env(envir) = op
##             return(title)
##         })
##     }
## }
## debug: if (grepl(&quot;%s&quot;, title)) {
##     title = apply(unique(split), 1, function(x) {
##         lt = lapply(x, function(x) x)
##         lt$fmt = title
##         do.call(sprintf, lt)
##     })
## } else if (grepl(&quot;@\\{.+\\}&quot;, title)) {
##     title = apply(unique(split), 1, function(x) {
##         x = x
##         envir = environment()
##         title = get(&quot;title&quot;)
##         op = parent.env(envir)
##         calling_env = object@heatmap_param$calling_env
##         parent.env(envir) = calling_env
##         title = GetoptLong::qq(title, envir = envir)
##         parent.env(envir) = op
##         return(title)
##     })
## } else if (grepl(&quot;\\{.+\\}&quot;, title)) {
##     if (!requireNamespace(&quot;glue&quot;)) {
##         stop_wrap(&quot;You need to install glue package.&quot;)
##     }
##     title = apply(unique(split), 1, function(x) {
##         x = x
##         envir = environment()
##         title = get(&quot;title&quot;)
##         op = parent.env(envir)
##         calling_env = object@heatmap_param$calling_env
##         parent.env(envir) = calling_env
##         title = glue::glue(title, envir = calling_env)
##         parent.env(envir) = op
##         return(title)
##     })
## }
## debug: title = apply(unique(split), 1, function(x) {
##     lt = lapply(x, function(x) x)
##     lt$fmt = title
##     do.call(sprintf, lt)
## })
## debug: slot(object, paste0(which, &quot;_title&quot;)) = title
## debug: return(object)</code></pre>
<p>If you know the final number of row slices, you can directly set a vector of
titles to <code>row_title</code>. Be careful the number of row slices is not always
identical to <code>nlevel_1*nlevel_2*...</code>.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="a-single-heatmap.html#cb96-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, </span>
<span id="cb96-2"><a href="a-single-heatmap.html#cb96-2"></a>    <span class="dt">row_title =</span> <span class="kw">c</span>(<span class="st">&quot;top_slice&quot;</span>, <span class="st">&quot;middle_top_slice&quot;</span>, <span class="st">&quot;middle_bottom_slice&quot;</span>, <span class="st">&quot;bottom_slice&quot;</span>),</span>
<span id="cb96-3"><a href="a-single-heatmap.html#cb96-3"></a>    <span class="dt">row_title_rot =</span> <span class="dv">0</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-52-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If the length of <code>row_title</code> is specified as a single string, it will be like
a single title for all slices.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="a-single-heatmap.html#cb97-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, <span class="dt">row_title =</span> <span class="st">&quot;there are four slices&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-53-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If you still want titles for each slice, but also a global title, you can do
as follows.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="a-single-heatmap.html#cb98-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, <span class="dt">row_title =</span> <span class="st">&quot;%s|%s&quot;</span>)</span>
<span id="cb98-2"><a href="a-single-heatmap.html#cb98-2"></a><span class="kw">draw</span>(ht, <span class="dt">row_title =</span> <span class="st">&quot;I am a row title&quot;</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-54-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Actually the <code>row_title</code> used in <code>draw()</code> function is the row title of the
heatmap list, although in the example there is only one heatmap. The <code>draw()</code>
function and the heatmap list will be introduced in Chapter
<a href="a-list-of-heatmaps.html#a-list-of-heatmaps">4</a>.</p>
<p>If <code>row_title</code> is set to <code>NULL</code>, no row title will be drawn.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="a-single-heatmap.html#cb99-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_split =</span> split, <span class="dt">row_title =</span> <span class="ot">NULL</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-55-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>All these rules also work for column titles for slices.</p>
</div>
<div id="graphic-parameters-for-splitting" class="section level3" number="2.7.6">
<h3><span class="header-section-number">2.7.6</span> Graphic parameters for splitting</h3>
<p>When splitting is applied on rows/columns, graphic parameters for row/column
title and row/column names can be specified as same length as number of
slices.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="a-single-heatmap.html#cb100-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, </span>
<span id="cb100-2"><a href="a-single-heatmap.html#cb100-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">row_title_gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">font =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>),</span>
<span id="cb100-3"><a href="a-single-heatmap.html#cb100-3"></a>    <span class="dt">row_names_gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;orange&quot;</span>), <span class="dt">fontsize =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">14</span>)),</span>
<span id="cb100-4"><a href="a-single-heatmap.html#cb100-4"></a>    <span class="dt">column_km =</span> <span class="dv">3</span>, <span class="dt">column_title_gp =</span> <span class="kw">gpar</span>(<span class="dt">fill =</span> <span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>), <span class="dt">font =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>),</span>
<span id="cb100-5"><a href="a-single-heatmap.html#cb100-5"></a>    <span class="dt">column_names_gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;purple&quot;</span>), <span class="dt">fontsize =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">14</span>, <span class="dv">8</span>)))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_graphical_parameter-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="gaps-between-slices" class="section level3" number="2.7.7">
<h3><span class="header-section-number">2.7.7</span> Gaps between slices</h3>
<p>The space of gaps between row/column slices can be controlled by
<code>row_gap</code>/<code>column_gap</code>. The value can be a single unit or a vector of units.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="a-single-heatmap.html#cb101-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">3</span>, <span class="dt">row_gap =</span> <span class="kw">unit</span>(<span class="dv">5</span>, <span class="st">&quot;mm&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_gap-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="a-single-heatmap.html#cb102-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">3</span>, <span class="dt">row_gap =</span> <span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="st">&quot;mm&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_gap-2.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="a-single-heatmap.html#cb103-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">3</span>, <span class="dt">row_gap =</span> <span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="st">&quot;mm&quot;</span>),</span>
<span id="cb103-2"><a href="a-single-heatmap.html#cb103-2"></a>    <span class="dt">column_km =</span> <span class="dv">3</span>, <span class="dt">column_gap =</span> <span class="kw">unit</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="st">&quot;mm&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/split_gap-3.png" width="672" style="display: block; margin: auto;" /></p>
<p>When heatmap border is added by setting <code>border = TRUE</code>, the border of every
slice is added.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="a-single-heatmap.html#cb104-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">3</span>, <span class="dt">border =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-56-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If you set gap size to zero, the heatmap will look like it is partitioned by
vertical and horizontal lines.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="a-single-heatmap.html#cb105-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">3</span>, </span>
<span id="cb105-2"><a href="a-single-heatmap.html#cb105-2"></a>    <span class="dt">row_gap =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>), <span class="dt">column_gap =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">&quot;mm&quot;</span>), <span class="dt">border =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-57-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="split-heatmap-annotations" class="section level3" number="2.7.8">
<h3><span class="header-section-number">2.7.8</span> Split heatmap annotations</h3>
<p>When the heatmap is split, all the heatmap components are split accordingly.
Following gives you a simple example and the heatmap annotation will be
introduced in Chapter <a href="heatmap-annotations.html#heatmap-annotations">3</a>.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="a-single-heatmap.html#cb106-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">3</span>,</span>
<span id="cb106-2"><a href="a-single-heatmap.html#cb106-2"></a>    <span class="dt">top_annotation =</span> <span class="kw">HeatmapAnnotation</span>(<span class="dt">foo1 =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>, <span class="dt">bar1 =</span> <span class="kw">anno_points</span>(<span class="kw">runif</span>(<span class="dv">24</span>))),</span>
<span id="cb106-3"><a href="a-single-heatmap.html#cb106-3"></a>    <span class="dt">right_annotation =</span> <span class="kw">rowAnnotation</span>(<span class="dt">foo2 =</span> <span class="dv">18</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">bar2 =</span> <span class="kw">anno_barplot</span>(<span class="kw">runif</span>(<span class="dv">18</span>)))</span>
<span id="cb106-4"><a href="a-single-heatmap.html#cb106-4"></a>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-58-1.png" width="576" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="heatmap-as-raster-image" class="section level2" number="2.8">
<h2><span class="header-section-number">2.8</span> Heatmap as raster image</h2>
<p>Saving plots in PDF format is kind like best parctice to preserve the quality
of the plots. However, when there are too many rows (say, &gt; 10000), the output
PDF file would be huge and it takes long time and memory to read the whole
plot. On the other hand, details of the huge matrix will not be seen in
limited size of PDF file. Rendering heatmaps (the heatmap body) as raster
images will effectively reduce the file size while the plot looks exactly the
same for your screen or if you print it out. In <code>Heatmap()</code> function, there
are four options which control how to generate the raster image: <code>use_raster</code>,
<code>raster_device</code>, <code>raster_quality</code>, <code>raster_device_param</code>.</p>
<p>You can choose graphic device (<code>png</code>, <code>jpeg</code> and <code>tiff</code>) by <code>raster_device</code>,
control the quality of the raster image by <code>raster_quality</code>, and pass further
parameters for a specific device by <code>raster_device_param</code>.</p>
<p>If <code>raster_quality</code> is set to 1, internally, a PNG (if <code>raster_device</code> is set
to <code>png</code>) file is generated with the same physical size as the heatmap body
and refit into the heatmap body as a raster image. The png file generated has
the size of <code>raster_quality*width</code> and <code>raster_quality*height</code>. So a larger
<code>raster_quality</code> value gives you a better reservation of the original
resolution.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="a-single-heatmap.html#cb107-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb107-2"><a href="a-single-heatmap.html#cb107-2"></a><span class="kw">Heatmap</span>(mat, <span class="dt">use_raster =</span> <span class="ot">TRUE</span>, <span class="dt">raster_quality =</span> <span class="dv">2</span>)</span></code></pre></div>
<p>In <strong>Complexheatmap</strong>, <code>use_raster</code> is by default turned on if the number of
rows or columns is more than 2000.</p>
<p>Following example compares the PDF file size with raster image by different
devices.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="a-single-heatmap.html#cb108-1"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb108-2"><a href="a-single-heatmap.html#cb108-2"></a>mat2 =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(<span class="dv">10000</span><span class="op">*</span><span class="dv">100</span>), <span class="dt">ncol =</span> <span class="dv">100</span>)</span>
<span id="cb108-3"><a href="a-single-heatmap.html#cb108-3"></a><span class="kw">pdf</span>(<span class="st">&quot;heatmap.pdf&quot;</span>, <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">8</span>)</span>
<span id="cb108-4"><a href="a-single-heatmap.html#cb108-4"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>, <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>, <span class="dt">use_raster =</span> <span class="ot">FALSE</span>)</span>
<span id="cb108-5"><a href="a-single-heatmap.html#cb108-5"></a><span class="kw">dev.off</span>()</span>
<span id="cb108-6"><a href="a-single-heatmap.html#cb108-6"></a></span>
<span id="cb108-7"><a href="a-single-heatmap.html#cb108-7"></a><span class="kw">pdf</span>(<span class="st">&quot;heatmap_raster_by_png.pdf&quot;</span>, <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">8</span>)</span>
<span id="cb108-8"><a href="a-single-heatmap.html#cb108-8"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>, <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>, <span class="dt">use_raster =</span> <span class="ot">TRUE</span>, </span>
<span id="cb108-9"><a href="a-single-heatmap.html#cb108-9"></a>    <span class="dt">raster_device =</span> <span class="st">&quot;png&quot;</span>)</span>
<span id="cb108-10"><a href="a-single-heatmap.html#cb108-10"></a><span class="kw">dev.off</span>()</span>
<span id="cb108-11"><a href="a-single-heatmap.html#cb108-11"></a></span>
<span id="cb108-12"><a href="a-single-heatmap.html#cb108-12"></a><span class="kw">pdf</span>(<span class="st">&quot;heatmap_raster_by_jpeg.pdf&quot;</span>, <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">8</span>)</span>
<span id="cb108-13"><a href="a-single-heatmap.html#cb108-13"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>, <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>, <span class="dt">use_raster =</span> <span class="ot">TRUE</span>, </span>
<span id="cb108-14"><a href="a-single-heatmap.html#cb108-14"></a>    <span class="dt">raster_device =</span> <span class="st">&quot;jpeg&quot;</span>)</span>
<span id="cb108-15"><a href="a-single-heatmap.html#cb108-15"></a><span class="kw">dev.off</span>()</span>
<span id="cb108-16"><a href="a-single-heatmap.html#cb108-16"></a></span>
<span id="cb108-17"><a href="a-single-heatmap.html#cb108-17"></a><span class="kw">pdf</span>(<span class="st">&quot;heatmap_raster_by_tiff.pdf&quot;</span>, <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">8</span>)</span>
<span id="cb108-18"><a href="a-single-heatmap.html#cb108-18"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>, <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>, <span class="dt">use_raster =</span> <span class="ot">TRUE</span>, </span>
<span id="cb108-19"><a href="a-single-heatmap.html#cb108-19"></a>    <span class="dt">raster_device =</span> <span class="st">&quot;tiff&quot;</span>)</span>
<span id="cb108-20"><a href="a-single-heatmap.html#cb108-20"></a><span class="kw">dev.off</span>()</span>
<span id="cb108-21"><a href="a-single-heatmap.html#cb108-21"></a></span>
<span id="cb108-22"><a href="a-single-heatmap.html#cb108-22"></a><span class="kw">pdf</span>(<span class="st">&quot;heatmap_raster_by_CairoPNG.pdf&quot;</span>, <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">8</span>)</span>
<span id="cb108-23"><a href="a-single-heatmap.html#cb108-23"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>, <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>, <span class="dt">use_raster =</span> <span class="ot">TRUE</span>, </span>
<span id="cb108-24"><a href="a-single-heatmap.html#cb108-24"></a>    <span class="dt">raster_device =</span> <span class="st">&quot;CairoPNG&quot;</span>)</span>
<span id="cb108-25"><a href="a-single-heatmap.html#cb108-25"></a><span class="kw">dev.off</span>()</span>
<span id="cb108-26"><a href="a-single-heatmap.html#cb108-26"></a></span>
<span id="cb108-27"><a href="a-single-heatmap.html#cb108-27"></a><span class="kw">pdf</span>(<span class="st">&quot;heatmap_raster_by_CairoJPEG.pdf&quot;</span>, <span class="dt">width =</span> <span class="dv">8</span>, <span class="dt">height =</span> <span class="dv">8</span>)</span>
<span id="cb108-28"><a href="a-single-heatmap.html#cb108-28"></a><span class="kw">Heatmap</span>(mat2, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>, <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>, <span class="dt">use_raster =</span> <span class="ot">TRUE</span>, </span>
<span id="cb108-29"><a href="a-single-heatmap.html#cb108-29"></a>    <span class="dt">raster_device =</span> <span class="st">&quot;CairoJPEG&quot;</span>)</span>
<span id="cb108-30"><a href="a-single-heatmap.html#cb108-30"></a><span class="kw">dev.off</span>()</span></code></pre></div>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="a-single-heatmap.html#cb109-1"></a>all_files =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;heatmap.pdf&quot;</span>, <span class="st">&quot;heatmap_raster_by_png.pdf&quot;</span>, </span>
<span id="cb109-2"><a href="a-single-heatmap.html#cb109-2"></a>              <span class="st">&quot;heatmap_raster_by_jpeg.pdf&quot;</span>, <span class="st">&quot;heatmap_raster_by_tiff.pdf&quot;</span>,</span>
<span id="cb109-3"><a href="a-single-heatmap.html#cb109-3"></a>              <span class="st">&quot;heatmap_raster_by_CairoPNG.pdf&quot;</span>, <span class="st">&quot;heatmap_raster_by_CairoJPEG.pdf&quot;</span>)</span>
<span id="cb109-4"><a href="a-single-heatmap.html#cb109-4"></a>fs =<span class="st"> </span><span class="kw">file.size</span>(all_files)</span>
<span id="cb109-5"><a href="a-single-heatmap.html#cb109-5"></a><span class="kw">names</span>(fs) =<span class="st"> </span>all_files</span>
<span id="cb109-6"><a href="a-single-heatmap.html#cb109-6"></a><span class="kw">sapply</span>(fs, <span class="cf">function</span>(x) <span class="kw">paste</span>(<span class="kw">round</span>(x<span class="op">/</span><span class="dv">1024</span>), <span class="st">&quot;KB&quot;</span>))</span></code></pre></div>
<pre><code>##                     heatmap.pdf       heatmap_raster_by_png.pdf 
##                       &quot;6583 KB&quot;                        &quot;374 KB&quot; 
##      heatmap_raster_by_jpeg.pdf      heatmap_raster_by_tiff.pdf 
##                       &quot;2845 KB&quot;                        &quot;374 KB&quot; 
##  heatmap_raster_by_CairoPNG.pdf heatmap_raster_by_CairoJPEG.pdf 
##                        &quot;307 KB&quot;                       &quot;2975 KB&quot;</code></pre>
</div>
<div id="customize-the-heatmap-body" class="section level2" number="2.9">
<h2><span class="header-section-number">2.9</span> Customize the heatmap body</h2>
<p>The heatmap body can be self-defined to add more types of graphics. By default
the heatmap body is composed by a matrix of small rectangles (it might be
called grids in other parts of this documentation, but let’s call it “<em>cells</em>”
here) with different filled colors. However, it is also possible to add more
graphics or symbols as additional layers on the heatmap. There are two
arguments <code>cell_fun</code> and <code>layer_fun</code> which both should be user-defined
functions.</p>
<div id="cell-fun" class="section level3" number="2.9.1">
<h3><span class="header-section-number">2.9.1</span> cell_fun</h3>
<p><code>cell_fun</code> draws in each cell repeatedly, which is internally executed in two
nested <code>for</code> loops, while <code>layer_fun</code> is the vectorized version of <code>cell_fun</code>.
<code>cell_fun</code> is easier to understand but <code>layer_fun</code> is much faster to execute
and more customizable.</p>
<p><code>cell_fun</code> expects a function with 7 arguments (the argument names can be
different from following, but the order must be the same), which are:</p>
<ul>
<li><code>j</code>: column index in the matrix. Column index corresponds to the x-direction
in the viewport, that’s why <code>j</code> is put as the first argument.</li>
<li><code>i</code>: row index in the matrix.</li>
<li><code>x</code>: x coordinate of middle point of the cell which is measured in the
viewport of the heatmap body.</li>
<li><code>y</code>: y coordinate of middle point of the cell which is measured in the
viewport of the heatmap body.</li>
<li><code>width</code>: width of the cell. The value is <code>unit(1/ncol(sub_mat), "npc")</code>
where <code>sub_mat</code> correspond to the sub-matrix by row splitting and column
splitting.</li>
<li><code>height</code>: height of the cell. The value is <code>unit(1/nrow(sub_mat), "npc")</code>.</li>
<li><code>fill</code>: color of the cell.</li>
</ul>
<p>The values for the seven arguments are automatically sent to the function when
executed in each cell.</p>
<p>The most common use is to add values in the matrix onto the heatmap:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="a-single-heatmap.html#cb111-1"></a>small_mat =<span class="st"> </span>mat[<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>]</span>
<span id="cb111-2"><a href="a-single-heatmap.html#cb111-2"></a>col_fun =<span class="st"> </span><span class="kw">colorRamp2</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>))</span>
<span id="cb111-3"><a href="a-single-heatmap.html#cb111-3"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb111-4"><a href="a-single-heatmap.html#cb111-4"></a>    <span class="dt">cell_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb111-5"><a href="a-single-heatmap.html#cb111-5"></a>        <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, small_mat[i, j]), x, y, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb111-6"><a href="a-single-heatmap.html#cb111-6"></a>})</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-63-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>and we can also choose only to add text for the cells with positive values:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="a-single-heatmap.html#cb112-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>,  <span class="dt">col =</span> col_fun,</span>
<span id="cb112-2"><a href="a-single-heatmap.html#cb112-2"></a>    <span class="dt">cell_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb112-3"><a href="a-single-heatmap.html#cb112-3"></a>        <span class="cf">if</span>(small_mat[i, j] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</span>
<span id="cb112-4"><a href="a-single-heatmap.html#cb112-4"></a>            <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, small_mat[i, j]), x, y, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb112-5"><a href="a-single-heatmap.html#cb112-5"></a>})</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-64-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>You can split the heatmap without doing anything extra to <code>cell_fun</code>:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="a-single-heatmap.html#cb113-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb113-2"><a href="a-single-heatmap.html#cb113-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">2</span>,</span>
<span id="cb113-3"><a href="a-single-heatmap.html#cb113-3"></a>    <span class="dt">cell_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb113-4"><a href="a-single-heatmap.html#cb113-4"></a>        <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, small_mat[i, j]), x, y, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb113-5"><a href="a-single-heatmap.html#cb113-5"></a>})</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-65-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>In following example, we make a heatmap which shows correlation matrix similar
as the <strong>corrplot</strong> package:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="a-single-heatmap.html#cb114-1"></a>cor_mat =<span class="st"> </span><span class="kw">cor</span>(small_mat)</span>
<span id="cb114-2"><a href="a-single-heatmap.html#cb114-2"></a>od =<span class="st"> </span><span class="kw">hclust</span>(<span class="kw">dist</span>(cor_mat))<span class="op">$</span>order</span>
<span id="cb114-3"><a href="a-single-heatmap.html#cb114-3"></a>cor_mat =<span class="st"> </span>cor_mat[od, od]</span>
<span id="cb114-4"><a href="a-single-heatmap.html#cb114-4"></a>nm =<span class="st"> </span><span class="kw">rownames</span>(cor_mat)</span>
<span id="cb114-5"><a href="a-single-heatmap.html#cb114-5"></a>col_fun =<span class="st"> </span>circlize<span class="op">::</span><span class="kw">colorRamp2</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>))</span>
<span id="cb114-6"><a href="a-single-heatmap.html#cb114-6"></a><span class="co"># `col = col_fun` here is used to generate the legend</span></span>
<span id="cb114-7"><a href="a-single-heatmap.html#cb114-7"></a><span class="kw">Heatmap</span>(cor_mat, <span class="dt">name =</span> <span class="st">&quot;correlation&quot;</span>, <span class="dt">col =</span> col_fun, <span class="dt">rect_gp =</span> <span class="kw">gpar</span>(<span class="dt">type =</span> <span class="st">&quot;none&quot;</span>), </span>
<span id="cb114-8"><a href="a-single-heatmap.html#cb114-8"></a>    <span class="dt">cell_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb114-9"><a href="a-single-heatmap.html#cb114-9"></a>        <span class="kw">grid.rect</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">width =</span> width, <span class="dt">height =</span> height, </span>
<span id="cb114-10"><a href="a-single-heatmap.html#cb114-10"></a>            <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">fill =</span> <span class="ot">NA</span>))</span>
<span id="cb114-11"><a href="a-single-heatmap.html#cb114-11"></a>        <span class="cf">if</span>(i <span class="op">==</span><span class="st"> </span>j) {</span>
<span id="cb114-12"><a href="a-single-heatmap.html#cb114-12"></a>            <span class="kw">grid.text</span>(nm[i], <span class="dt">x =</span> x, <span class="dt">y =</span> y)</span>
<span id="cb114-13"><a href="a-single-heatmap.html#cb114-13"></a>        } <span class="cf">else</span> <span class="cf">if</span>(i <span class="op">&gt;</span><span class="st"> </span>j) {</span>
<span id="cb114-14"><a href="a-single-heatmap.html#cb114-14"></a>            <span class="kw">grid.circle</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">r =</span> <span class="kw">abs</span>(cor_mat[i, j])<span class="op">/</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">min</span>(<span class="kw">unit.c</span>(width, height)), </span>
<span id="cb114-15"><a href="a-single-heatmap.html#cb114-15"></a>                <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fill =</span> <span class="kw">col_fun</span>(cor_mat[i, j]), <span class="dt">col =</span> <span class="ot">NA</span>))</span>
<span id="cb114-16"><a href="a-single-heatmap.html#cb114-16"></a>        } <span class="cf">else</span> {</span>
<span id="cb114-17"><a href="a-single-heatmap.html#cb114-17"></a>            <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, cor_mat[i, j]), x, y, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb114-18"><a href="a-single-heatmap.html#cb114-18"></a>        }</span>
<span id="cb114-19"><a href="a-single-heatmap.html#cb114-19"></a>    }, <span class="dt">cluster_rows =</span> <span class="ot">FALSE</span>, <span class="dt">cluster_columns =</span> <span class="ot">FALSE</span>,</span>
<span id="cb114-20"><a href="a-single-heatmap.html#cb114-20"></a>    <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>, <span class="dt">show_column_names =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/cell_fun-1.png" width="624" style="display: block; margin: auto;" /></p>
<p>As you may see in previous plot, when setting the non-standard parameter
<code>rect_gp = gpar(type = "none")</code>, the clustering is performed but nothing is
drawn on the heatmap body.</p>
<p>One last example is to visualize a <a href="https://en.wikipedia.org/wiki/Go_%28game%29">GO
game</a>. The input data takes
records of moves in the game.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="a-single-heatmap.html#cb115-1"></a>str =<span class="st"> &quot;B[cp];W[pq];B[dc];W[qd];B[eq];W[od];B[de];W[jc];B[qk];W[qn]</span></span>
<span id="cb115-2"><a href="a-single-heatmap.html#cb115-2"></a><span class="st">;B[qh];W[ck];B[ci];W[cn];B[hc];W[je];B[jq];W[df];B[ee];W[cf]</span></span>
<span id="cb115-3"><a href="a-single-heatmap.html#cb115-3"></a><span class="st">;B[ei];W[bc];B[ce];W[be];B[bd];W[cd];B[bf];W[ad];B[bg];W[cc]</span></span>
<span id="cb115-4"><a href="a-single-heatmap.html#cb115-4"></a><span class="st">;B[eb];W[db];B[ec];W[lq];B[nq];W[jp];B[iq];W[kq];B[pp];W[op]</span></span>
<span id="cb115-5"><a href="a-single-heatmap.html#cb115-5"></a><span class="st">;B[po];W[oq];B[rp];W[ql];B[oo];W[no];B[pl];W[pm];B[np];W[qq]</span></span>
<span id="cb115-6"><a href="a-single-heatmap.html#cb115-6"></a><span class="st">;B[om];W[ol];B[pk];W[qp];B[on];W[rm];B[mo];W[nr];B[rl];W[rk]</span></span>
<span id="cb115-7"><a href="a-single-heatmap.html#cb115-7"></a><span class="st">;B[qm];W[dp];B[dq];W[ql];B[or];W[mp];B[nn];W[mq];B[qm];W[bp]</span></span>
<span id="cb115-8"><a href="a-single-heatmap.html#cb115-8"></a><span class="st">;B[co];W[ql];B[no];W[pr];B[qm];W[dd];B[pn];W[ed];B[bo];W[eg]</span></span>
<span id="cb115-9"><a href="a-single-heatmap.html#cb115-9"></a><span class="st">;B[ef];W[dg];B[ge];W[gh];B[gf];W[gg];B[ek];W[ig];B[fd];W[en]</span></span>
<span id="cb115-10"><a href="a-single-heatmap.html#cb115-10"></a><span class="st">;B[bn];W[ip];B[dm];W[ff];B[cb];W[fe];B[hp];W[ho];B[hq];W[el]</span></span>
<span id="cb115-11"><a href="a-single-heatmap.html#cb115-11"></a><span class="st">;B[dl];W[fk];B[ej];W[fp];B[go];W[hn];B[fo];W[em];B[dn];W[eo]</span></span>
<span id="cb115-12"><a href="a-single-heatmap.html#cb115-12"></a><span class="st">;B[gp];W[ib];B[gc];W[pg];B[qg];W[ng];B[qc];W[re];B[pf];W[of]</span></span>
<span id="cb115-13"><a href="a-single-heatmap.html#cb115-13"></a><span class="st">;B[rc];W[ob];B[ph];W[qo];B[rn];W[mi];B[og];W[oe];B[qe];W[rd]</span></span>
<span id="cb115-14"><a href="a-single-heatmap.html#cb115-14"></a><span class="st">;B[rf];W[pd];B[gm];W[gl];B[fm];W[fl];B[lj];W[mj];B[lk];W[ro]</span></span>
<span id="cb115-15"><a href="a-single-heatmap.html#cb115-15"></a><span class="st">;B[hl];W[hk];B[ik];W[dk];B[bi];W[di];B[dj];W[dh];B[hj];W[gj]</span></span>
<span id="cb115-16"><a href="a-single-heatmap.html#cb115-16"></a><span class="st">;B[li];W[lh];B[kh];W[lg];B[jn];W[do];B[cl];W[ij];B[gk];W[bl]</span></span>
<span id="cb115-17"><a href="a-single-heatmap.html#cb115-17"></a><span class="st">;B[cm];W[hk];B[jk];W[lo];B[hi];W[hm];B[gk];W[bm];B[cn];W[hk]</span></span>
<span id="cb115-18"><a href="a-single-heatmap.html#cb115-18"></a><span class="st">;B[il];W[cq];B[bq];W[ii];B[sm];W[jo];B[kn];W[fq];B[ep];W[cj]</span></span>
<span id="cb115-19"><a href="a-single-heatmap.html#cb115-19"></a><span class="st">;B[bk];W[er];B[cr];W[gr];B[gk];W[fj];B[ko];W[kp];B[hr];W[jr]</span></span>
<span id="cb115-20"><a href="a-single-heatmap.html#cb115-20"></a><span class="st">;B[nh];W[mh];B[mk];W[bb];B[da];W[jh];B[ic];W[id];B[hb];W[jb]</span></span>
<span id="cb115-21"><a href="a-single-heatmap.html#cb115-21"></a><span class="st">;B[oj];W[fn];B[fs];W[fr];B[gs];W[es];B[hs];W[gn];B[kr];W[is]</span></span>
<span id="cb115-22"><a href="a-single-heatmap.html#cb115-22"></a><span class="st">;B[dr];W[fi];B[bj];W[hd];B[gd];W[ln];B[lm];W[oi];B[oh];W[ni]</span></span>
<span id="cb115-23"><a href="a-single-heatmap.html#cb115-23"></a><span class="st">;B[pi];W[ki];B[kj];W[ji];B[so];W[rq];B[if];W[jf];B[hh];W[hf]</span></span>
<span id="cb115-24"><a href="a-single-heatmap.html#cb115-24"></a><span class="st">;B[he];W[ie];B[hg];W[ba];B[ca];W[sp];B[im];W[sn];B[rm];W[pe]</span></span>
<span id="cb115-25"><a href="a-single-heatmap.html#cb115-25"></a><span class="st">;B[qf];W[if];B[hk];W[nj];B[nk];W[lr];B[mn];W[af];B[ag];W[ch]</span></span>
<span id="cb115-26"><a href="a-single-heatmap.html#cb115-26"></a><span class="st">;B[bh];W[lp];B[ia];W[ja];B[ha];W[sf];B[sg];W[se];B[eh];W[fh]</span></span>
<span id="cb115-27"><a href="a-single-heatmap.html#cb115-27"></a><span class="st">;B[in];W[ih];B[ae];W[so];B[af]&quot;</span></span></code></pre></div>
<p>We convert it into a matrix:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="a-single-heatmap.html#cb116-1"></a>str =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">n&quot;</span>, <span class="st">&quot;&quot;</span>, str)</span>
<span id="cb116-2"><a href="a-single-heatmap.html#cb116-2"></a>step =<span class="st"> </span><span class="kw">strsplit</span>(str, <span class="st">&quot;;&quot;</span>)[[<span class="dv">1</span>]]</span>
<span id="cb116-3"><a href="a-single-heatmap.html#cb116-3"></a>type =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;(B|W).*&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, step)</span>
<span id="cb116-4"><a href="a-single-heatmap.html#cb116-4"></a>row =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;(B|W)</span><span class="ch">\\</span><span class="st">[(.).</span><span class="ch">\\</span><span class="st">]&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2&quot;</span>, step)</span>
<span id="cb116-5"><a href="a-single-heatmap.html#cb116-5"></a>column =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;(B|W)</span><span class="ch">\\</span><span class="st">[.(.)</span><span class="ch">\\</span><span class="st">]&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2&quot;</span>, step)</span>
<span id="cb116-6"><a href="a-single-heatmap.html#cb116-6"></a></span>
<span id="cb116-7"><a href="a-single-heatmap.html#cb116-7"></a>go_mat =<span class="st"> </span><span class="kw">matrix</span>(<span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</span>
<span id="cb116-8"><a href="a-single-heatmap.html#cb116-8"></a><span class="kw">rownames</span>(go_mat) =<span class="st"> </span>letters[<span class="dv">1</span><span class="op">:</span><span class="dv">19</span>]</span>
<span id="cb116-9"><a href="a-single-heatmap.html#cb116-9"></a><span class="kw">colnames</span>(go_mat) =<span class="st"> </span>letters[<span class="dv">1</span><span class="op">:</span><span class="dv">19</span>]</span>
<span id="cb116-10"><a href="a-single-heatmap.html#cb116-10"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">seq_along</span>(row)) {</span>
<span id="cb116-11"><a href="a-single-heatmap.html#cb116-11"></a>    go_mat[row[i], column[i]] =<span class="st"> </span>type[i]</span>
<span id="cb116-12"><a href="a-single-heatmap.html#cb116-12"></a>}</span>
<span id="cb116-13"><a href="a-single-heatmap.html#cb116-13"></a>go_mat[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>##   a   b   c   d  
## a NA  NA  NA  &quot;W&quot;
## b &quot;W&quot; &quot;W&quot; &quot;W&quot; &quot;B&quot;
## c &quot;B&quot; &quot;B&quot; &quot;W&quot; &quot;W&quot;
## d &quot;B&quot; &quot;W&quot; &quot;B&quot; &quot;W&quot;</code></pre>
<p>Black and white stones are put based on the values in the matrix:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="a-single-heatmap.html#cb118-1"></a><span class="kw">Heatmap</span>(go_mat, <span class="dt">name =</span> <span class="st">&quot;go&quot;</span>, <span class="dt">rect_gp =</span> <span class="kw">gpar</span>(<span class="dt">type =</span> <span class="st">&quot;none&quot;</span>),</span>
<span id="cb118-2"><a href="a-single-heatmap.html#cb118-2"></a>    <span class="dt">cell_fun =</span> <span class="cf">function</span>(j, i, x, y, w, h, col) {</span>
<span id="cb118-3"><a href="a-single-heatmap.html#cb118-3"></a>        <span class="kw">grid.rect</span>(x, y, w, h, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fill =</span> <span class="st">&quot;#dcb35c&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>))</span>
<span id="cb118-4"><a href="a-single-heatmap.html#cb118-4"></a>        <span class="cf">if</span>(i <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb118-5"><a href="a-single-heatmap.html#cb118-5"></a>            <span class="kw">grid.segments</span>(x, y<span class="op">-</span>h<span class="op">*</span><span class="fl">0.5</span>, x, y)</span>
<span id="cb118-6"><a href="a-single-heatmap.html#cb118-6"></a>        } <span class="cf">else</span> <span class="cf">if</span>(i <span class="op">==</span><span class="st"> </span><span class="kw">nrow</span>(go_mat)) {</span>
<span id="cb118-7"><a href="a-single-heatmap.html#cb118-7"></a>            <span class="kw">grid.segments</span>(x, y, x, y<span class="op">+</span>h<span class="op">*</span><span class="fl">0.5</span>)</span>
<span id="cb118-8"><a href="a-single-heatmap.html#cb118-8"></a>        } <span class="cf">else</span> {</span>
<span id="cb118-9"><a href="a-single-heatmap.html#cb118-9"></a>            <span class="kw">grid.segments</span>(x, y<span class="op">-</span>h<span class="op">*</span><span class="fl">0.5</span>, x, y<span class="op">+</span>h<span class="op">*</span><span class="fl">0.5</span>)</span>
<span id="cb118-10"><a href="a-single-heatmap.html#cb118-10"></a>        }</span>
<span id="cb118-11"><a href="a-single-heatmap.html#cb118-11"></a>        <span class="cf">if</span>(j <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb118-12"><a href="a-single-heatmap.html#cb118-12"></a>            <span class="kw">grid.segments</span>(x, y, x<span class="op">+</span>w<span class="op">*</span><span class="fl">0.5</span>, y)        </span>
<span id="cb118-13"><a href="a-single-heatmap.html#cb118-13"></a>        } <span class="cf">else</span> <span class="cf">if</span>(j <span class="op">==</span><span class="st"> </span><span class="kw">ncol</span>(go_mat)) {</span>
<span id="cb118-14"><a href="a-single-heatmap.html#cb118-14"></a>            <span class="kw">grid.segments</span>(x<span class="op">-</span>w<span class="op">*</span><span class="fl">0.5</span>, y, x, y)</span>
<span id="cb118-15"><a href="a-single-heatmap.html#cb118-15"></a>        } <span class="cf">else</span> {</span>
<span id="cb118-16"><a href="a-single-heatmap.html#cb118-16"></a>            <span class="kw">grid.segments</span>(x<span class="op">-</span>w<span class="op">*</span><span class="fl">0.5</span>, y, x<span class="op">+</span>w<span class="op">*</span><span class="fl">0.5</span>, y)</span>
<span id="cb118-17"><a href="a-single-heatmap.html#cb118-17"></a>        }</span>
<span id="cb118-18"><a href="a-single-heatmap.html#cb118-18"></a></span>
<span id="cb118-19"><a href="a-single-heatmap.html#cb118-19"></a>        <span class="cf">if</span>(i <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">16</span>) <span class="op">&amp;</span><span class="st"> </span>j <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">16</span>)) {</span>
<span id="cb118-20"><a href="a-single-heatmap.html#cb118-20"></a>            <span class="kw">grid.points</span>(x, y, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">size =</span> <span class="kw">unit</span>(<span class="dv">2</span>, <span class="st">&quot;mm&quot;</span>))</span>
<span id="cb118-21"><a href="a-single-heatmap.html#cb118-21"></a>        }</span>
<span id="cb118-22"><a href="a-single-heatmap.html#cb118-22"></a>                </span>
<span id="cb118-23"><a href="a-single-heatmap.html#cb118-23"></a>        r =<span class="st"> </span><span class="kw">min</span>(<span class="kw">unit.c</span>(w, h))<span class="op">*</span><span class="fl">0.45</span></span>
<span id="cb118-24"><a href="a-single-heatmap.html#cb118-24"></a>        <span class="cf">if</span>(<span class="kw">is.na</span>(go_mat[i, j])) {</span>
<span id="cb118-25"><a href="a-single-heatmap.html#cb118-25"></a>        } <span class="cf">else</span> <span class="cf">if</span>(go_mat[i, j] <span class="op">==</span><span class="st"> &quot;W&quot;</span>) {</span>
<span id="cb118-26"><a href="a-single-heatmap.html#cb118-26"></a>            <span class="kw">grid.circle</span>(x, y, r, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;white&quot;</span>))</span>
<span id="cb118-27"><a href="a-single-heatmap.html#cb118-27"></a>        } <span class="cf">else</span> <span class="cf">if</span>(go_mat[i, j] <span class="op">==</span><span class="st"> &quot;B&quot;</span>) {</span>
<span id="cb118-28"><a href="a-single-heatmap.html#cb118-28"></a>            <span class="kw">grid.circle</span>(x, y, r, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fill =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>))</span>
<span id="cb118-29"><a href="a-single-heatmap.html#cb118-29"></a>        }</span>
<span id="cb118-30"><a href="a-single-heatmap.html#cb118-30"></a>    },</span>
<span id="cb118-31"><a href="a-single-heatmap.html#cb118-31"></a>    <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;B&quot;</span> =<span class="st"> &quot;black&quot;</span>, <span class="st">&quot;W&quot;</span> =<span class="st"> &quot;white&quot;</span>),</span>
<span id="cb118-32"><a href="a-single-heatmap.html#cb118-32"></a>    <span class="dt">show_row_names =</span> <span class="ot">FALSE</span>, <span class="dt">show_column_names =</span> <span class="ot">FALSE</span>,</span>
<span id="cb118-33"><a href="a-single-heatmap.html#cb118-33"></a>    <span class="dt">column_title =</span> <span class="st">&quot;One famous GO game&quot;</span>,</span>
<span id="cb118-34"><a href="a-single-heatmap.html#cb118-34"></a>    <span class="dt">heatmap_legend_param =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">&quot;Player&quot;</span>, <span class="dt">at =</span> <span class="kw">c</span>(<span class="st">&quot;B&quot;</span>, <span class="st">&quot;W&quot;</span>), </span>
<span id="cb118-35"><a href="a-single-heatmap.html#cb118-35"></a>        <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;player1&quot;</span>, <span class="st">&quot;player2&quot;</span>), <span class="dt">border =</span> <span class="st">&quot;black&quot;</span>)</span>
<span id="cb118-36"><a href="a-single-heatmap.html#cb118-36"></a>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-68-1.png" width="576" style="display: block; margin: auto;" /></p>
</div>
<div id="layer-fun" class="section level3" number="2.9.2">
<h3><span class="header-section-number">2.9.2</span> layer_fun</h3>
<p><code>cell_fun</code> adds graphics cell by cell, while <code>layer_fun</code> adds graphics in a
block-wise manner. Similar as <code>cell_fun</code>, <code>layer_fun</code> also needs seven
arguments, but they are all in vector form (<code>layer_fun</code> can also have a eighth and
ninth arguments which is introduced later this section):</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="a-single-heatmap.html#cb119-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb119-2"><a href="a-single-heatmap.html#cb119-2"></a><span class="kw">Heatmap</span>(..., <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, w, h, fill) {...})</span>
<span id="cb119-3"><a href="a-single-heatmap.html#cb119-3"></a><span class="co"># on you can capitalize the arguments to mark they are vectors</span></span>
<span id="cb119-4"><a href="a-single-heatmap.html#cb119-4"></a><span class="kw">Heatmap</span>(..., <span class="dt">layer_fun =</span> <span class="cf">function</span>(J, I, X, Y, W, H, F) {...})</span></code></pre></div>
<p><code>j</code> and <code>i</code> still contain the column and row indices corresponding to the
original matrix, but since now <code>layer_fun</code> applies to a block of cells (or a
block of heatmap if the heatmap is split), <code>j</code> and <code>i</code> are vectors for all
the cells in the current heatmap slice. Similarlly, <code>x</code>, <code>y</code>, <code>w</code>, <code>h</code> and
<code>fill</code> are all vectors corresponding to all cells in the current heatmap
slice.</p>
<p>Since <code>j</code> and <code>i</code> now are vectors, to get corresponding values in the matrix, we
cannot use the form as <code>mat[j, i]</code> because it gives you a sub-matrix with
<code>length(i)</code> rows and <code>length(j)</code> columns. Instead we can use <code>pindex()</code>
function from <strong>ComplexHeatmap</strong> which is like pairwise indexing for a matrix.
See follow example:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="a-single-heatmap.html#cb120-1"></a>mfoo =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>, <span class="dt">nr =</span> <span class="dv">3</span>)</span>
<span id="cb120-2"><a href="a-single-heatmap.html#cb120-2"></a>mfoo[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)]</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    1    7
## [2,]    2    8</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="a-single-heatmap.html#cb122-1"></a><span class="co"># but we actually want mfoo[1, 1] and mfoo[2, 3]</span></span>
<span id="cb122-2"><a href="a-single-heatmap.html#cb122-2"></a><span class="kw">pindex</span>(mfoo, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span></code></pre></div>
<pre><code>## [1] 1 8</code></pre>
<p>Next example shows the <code>layer_fun</code> version of adding text on heatmap. It’s
basically the same as the <code>cell_fun</code> version.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="a-single-heatmap.html#cb124-1"></a>col_fun =<span class="st"> </span><span class="kw">colorRamp2</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>))</span>
<span id="cb124-2"><a href="a-single-heatmap.html#cb124-2"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb124-3"><a href="a-single-heatmap.html#cb124-3"></a>    <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb124-4"><a href="a-single-heatmap.html#cb124-4"></a>        <span class="co"># since grid.text can also be vectorized</span></span>
<span id="cb124-5"><a href="a-single-heatmap.html#cb124-5"></a>        <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, <span class="kw">pindex</span>(small_mat, i, j)), x, y, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb124-6"><a href="a-single-heatmap.html#cb124-6"></a>})</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-71-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>And only add text to cells with positive values:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="a-single-heatmap.html#cb125-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun, </span>
<span id="cb125-2"><a href="a-single-heatmap.html#cb125-2"></a>    <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb125-3"><a href="a-single-heatmap.html#cb125-3"></a>        v =<span class="st"> </span><span class="kw">pindex</span>(small_mat, i, j)</span>
<span id="cb125-4"><a href="a-single-heatmap.html#cb125-4"></a>        l =<span class="st"> </span>v <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></span>
<span id="cb125-5"><a href="a-single-heatmap.html#cb125-5"></a>        <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, v[l]), x[l], y[l], <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb125-6"><a href="a-single-heatmap.html#cb125-6"></a>})</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-72-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>When the heatmap is split, <code>layer_fun</code> is applied in every slice.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="a-single-heatmap.html#cb126-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb126-2"><a href="a-single-heatmap.html#cb126-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">2</span>,</span>
<span id="cb126-3"><a href="a-single-heatmap.html#cb126-3"></a>    <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill) {</span>
<span id="cb126-4"><a href="a-single-heatmap.html#cb126-4"></a>        v =<span class="st"> </span><span class="kw">pindex</span>(small_mat, i, j)</span>
<span id="cb126-5"><a href="a-single-heatmap.html#cb126-5"></a>        <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, v), x, y, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb126-6"><a href="a-single-heatmap.html#cb126-6"></a>        <span class="cf">if</span>(<span class="kw">sum</span>(v <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)<span class="op">/</span><span class="kw">length</span>(v) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.75</span>) {</span>
<span id="cb126-7"><a href="a-single-heatmap.html#cb126-7"></a>            <span class="kw">grid.rect</span>(<span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;transparent&quot;</span>))</span>
<span id="cb126-8"><a href="a-single-heatmap.html#cb126-8"></a>        }</span>
<span id="cb126-9"><a href="a-single-heatmap.html#cb126-9"></a>})</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-73-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><code>layer_fun</code> can also have two more arguments which are the index for the
current row slice and column slice. E.g. we want to add borders for the top
right and bottom left slices.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="a-single-heatmap.html#cb127-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb127-2"><a href="a-single-heatmap.html#cb127-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">2</span>,</span>
<span id="cb127-3"><a href="a-single-heatmap.html#cb127-3"></a>    <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, width, height, fill, slice_r, slice_c) {</span>
<span id="cb127-4"><a href="a-single-heatmap.html#cb127-4"></a>        v =<span class="st"> </span><span class="kw">pindex</span>(small_mat, i, j)</span>
<span id="cb127-5"><a href="a-single-heatmap.html#cb127-5"></a>        <span class="kw">grid.text</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%.1f&quot;</span>, v), x, y, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">fontsize =</span> <span class="dv">10</span>))</span>
<span id="cb127-6"><a href="a-single-heatmap.html#cb127-6"></a>        <span class="cf">if</span>(slice_r <span class="op">!=</span><span class="st"> </span>slice_c) {</span>
<span id="cb127-7"><a href="a-single-heatmap.html#cb127-7"></a>            <span class="kw">grid.rect</span>(<span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">fill =</span> <span class="st">&quot;transparent&quot;</span>))</span>
<span id="cb127-8"><a href="a-single-heatmap.html#cb127-8"></a>        }</span>
<span id="cb127-9"><a href="a-single-heatmap.html#cb127-9"></a>})</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-74-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The advantage of <code>lay_fun</code> is it is not only fast to add graphics, but also it
provides more possibilities to customize the heatmap. Consider following
visualization: For each row in the heatmap, if values in the neighbouring two
columns have the same sign, we add a red line or a green line depending on the
sign of the two values. (Don’t be frightened by following code. They are explained
after the code.)</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="a-single-heatmap.html#cb128-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb128-2"><a href="a-single-heatmap.html#cb128-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">2</span>,</span>
<span id="cb128-3"><a href="a-single-heatmap.html#cb128-3"></a>    <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, w, h, fill) {</span>
<span id="cb128-4"><a href="a-single-heatmap.html#cb128-4"></a>        <span class="co"># restore_matrix() is explained after this chunk of code</span></span>
<span id="cb128-5"><a href="a-single-heatmap.html#cb128-5"></a>        ind_mat =<span class="st"> </span><span class="kw">restore_matrix</span>(j, i, x, y)</span>
<span id="cb128-6"><a href="a-single-heatmap.html#cb128-6"></a>        <span class="cf">for</span>(ir <span class="cf">in</span> <span class="kw">seq_len</span>(<span class="kw">nrow</span>(ind_mat))) {</span>
<span id="cb128-7"><a href="a-single-heatmap.html#cb128-7"></a>            <span class="co"># start from the second column</span></span>
<span id="cb128-8"><a href="a-single-heatmap.html#cb128-8"></a>            <span class="cf">for</span>(ic <span class="cf">in</span> <span class="kw">seq_len</span>(<span class="kw">ncol</span>(ind_mat))[<span class="op">-</span><span class="dv">1</span>]) {</span>
<span id="cb128-9"><a href="a-single-heatmap.html#cb128-9"></a>                ind1 =<span class="st"> </span>ind_mat[ir, ic<span class="dv">-1</span>] <span class="co"># previous column</span></span>
<span id="cb128-10"><a href="a-single-heatmap.html#cb128-10"></a>                ind2 =<span class="st"> </span>ind_mat[ir, ic]   <span class="co"># current column</span></span>
<span id="cb128-11"><a href="a-single-heatmap.html#cb128-11"></a>                v1 =<span class="st"> </span>small_mat[i[ind1], j[ind1]]</span>
<span id="cb128-12"><a href="a-single-heatmap.html#cb128-12"></a>                v2 =<span class="st"> </span>small_mat[i[ind2], j[ind2]]</span>
<span id="cb128-13"><a href="a-single-heatmap.html#cb128-13"></a>                <span class="cf">if</span>(v1 <span class="op">*</span><span class="st"> </span>v2 <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) { <span class="co"># if they have the same sign</span></span>
<span id="cb128-14"><a href="a-single-heatmap.html#cb128-14"></a>                    col =<span class="st"> </span><span class="kw">ifelse</span>(v1 <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;darkred&quot;</span>, <span class="st">&quot;darkgreen&quot;</span>)</span>
<span id="cb128-15"><a href="a-single-heatmap.html#cb128-15"></a>                    <span class="kw">grid.segments</span>(x[ind1], y[ind1], x[ind2], y[ind2],</span>
<span id="cb128-16"><a href="a-single-heatmap.html#cb128-16"></a>                        <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> col, <span class="dt">lwd =</span> <span class="dv">2</span>))</span>
<span id="cb128-17"><a href="a-single-heatmap.html#cb128-17"></a>                    <span class="kw">grid.points</span>(x[<span class="kw">c</span>(ind1, ind2)], y[<span class="kw">c</span>(ind1, ind2)], </span>
<span id="cb128-18"><a href="a-single-heatmap.html#cb128-18"></a>                        <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">gp =</span> <span class="kw">gpar</span>(<span class="dt">col =</span> col), <span class="dt">size =</span> <span class="kw">unit</span>(<span class="dv">4</span>, <span class="st">&quot;mm&quot;</span>))</span>
<span id="cb128-19"><a href="a-single-heatmap.html#cb128-19"></a>                }</span>
<span id="cb128-20"><a href="a-single-heatmap.html#cb128-20"></a>            }</span>
<span id="cb128-21"><a href="a-single-heatmap.html#cb128-21"></a>        }</span>
<span id="cb128-22"><a href="a-single-heatmap.html#cb128-22"></a>    }</span>
<span id="cb128-23"><a href="a-single-heatmap.html#cb128-23"></a>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-75-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The values that are sent to <code>layer_fun</code> are all vectors (for the vectorization
of the <strong>grid</strong> graphic functions), however, the heatmap slice where
<code>layer_fun</code> is applied to, is still represented by a matrix, thus, it would be
very convinient if all the arguments in <code>layer_fun</code> can be converted to the
sub-matrix for the current slice. Here, as shown in above example,
<code>restore_matrix()</code> does the job. <code>restore_matrix()</code> directly accepts the first
four argument in <code>layer_fun</code> and returns an index matrix, where rows and
columns correspond to the rows and columns in the current slice, from top to
bottom and from left to right. The values in the matrix are the natural order
of e.g. vector <code>j</code> in current slice.</p>
<p>If you run following code:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="a-single-heatmap.html#cb129-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb129-2"><a href="a-single-heatmap.html#cb129-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">2</span>,</span>
<span id="cb129-3"><a href="a-single-heatmap.html#cb129-3"></a>    <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, w, h, fill) {</span>
<span id="cb129-4"><a href="a-single-heatmap.html#cb129-4"></a>        ind_mat =<span class="st"> </span><span class="kw">restore_matrix</span>(j, i, x, y)</span>
<span id="cb129-5"><a href="a-single-heatmap.html#cb129-5"></a>        <span class="kw">print</span>(ind_mat)</span>
<span id="cb129-6"><a href="a-single-heatmap.html#cb129-6"></a>    }</span>
<span id="cb129-7"><a href="a-single-heatmap.html#cb129-7"></a>)</span></code></pre></div>
<p>The first output which is for the top-left slice:</p>
<pre><code>     [,1] [,2] [,3] [,4] [,5]
[1,]    1    4    7   10   13
[2,]    2    5    8   11   14
[3,]    3    6    9   12   15</code></pre>
<p>As you see, this is a three-row and five-column index matrix where the first
row corresponds to the top row in the slice. The values in the matrix
correspond to the natural index (i.e. 1, 2, …) in <code>j</code>, <code>i</code>, <code>x</code>, <code>y</code>,
… in <code>layer_fun</code>. Now, if we want to add values on the second column in the
top-left slice, the code which is put inside <code>layer_fun</code> would look like:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="a-single-heatmap.html#cb131-1"></a><span class="cf">for</span>(ind <span class="cf">in</span> ind_mat[, <span class="dv">2</span>]) {</span>
<span id="cb131-2"><a href="a-single-heatmap.html#cb131-2"></a>    <span class="kw">grid.text</span>(small_mat[i[ind], j[ind]], x[ind], y[ind], ...)</span>
<span id="cb131-3"><a href="a-single-heatmap.html#cb131-3"></a>}</span></code></pre></div>
<p>Now it is easier to understand the second example: we want to add points to
the second row and the third column in every slice:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="a-single-heatmap.html#cb132-1"></a><span class="kw">Heatmap</span>(small_mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">col =</span> col_fun,</span>
<span id="cb132-2"><a href="a-single-heatmap.html#cb132-2"></a>    <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">2</span>,</span>
<span id="cb132-3"><a href="a-single-heatmap.html#cb132-3"></a>    <span class="dt">layer_fun =</span> <span class="cf">function</span>(j, i, x, y, w, h, fill) {</span>
<span id="cb132-4"><a href="a-single-heatmap.html#cb132-4"></a>        ind_mat =<span class="st"> </span><span class="kw">restore_matrix</span>(j, i, x, y)</span>
<span id="cb132-5"><a href="a-single-heatmap.html#cb132-5"></a>        ind =<span class="st"> </span><span class="kw">unique</span>(<span class="kw">c</span>(ind_mat[<span class="dv">2</span>, ], ind_mat[, <span class="dv">3</span>]))</span>
<span id="cb132-6"><a href="a-single-heatmap.html#cb132-6"></a>        <span class="kw">grid.points</span>(x[ind], y[ind], <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">size =</span> <span class="kw">unit</span>(<span class="dv">4</span>, <span class="st">&quot;mm&quot;</span>))</span>
<span id="cb132-7"><a href="a-single-heatmap.html#cb132-7"></a>    }</span>
<span id="cb132-8"><a href="a-single-heatmap.html#cb132-8"></a>)</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-78-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="size-of-the-heatmap" class="section level2" number="2.10">
<h2><span class="header-section-number">2.10</span> Size of the heatmap</h2>
<p><code>width</code>, <code>heatmap_width</code>, <code>height</code> and <code>heatmap_height</code> control the size of
the heatmap. By default, all heatmap components have fixed width or height,
e.g. the width of row dendrogram is <code>1cm</code>. The width or the height of the
heatmap body fill the rest area of the final plotting region, which means, if
you draw it in an interactive graphic window and you change the size of the
window by draging it, the size of the heatmap body is automatically adjusted.</p>
<p><code>heatmap_width</code> and <code>heatmap_height</code> control the width/height of the complete
heatmap including all heatmap components (excluding the legends) while <code>width</code>
and <code>height</code> only control the width/height of the heamtap body. All these four
arguments can be set as absolute units.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="a-single-heatmap.html#cb133-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">width =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>), <span class="dt">height =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-79-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="a-single-heatmap.html#cb134-1"></a><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">heatmap_width =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>), <span class="dt">heatmap_height =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>))</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-79-2.png" width="672" style="display: block; margin: auto;" /></p>
<p>These four arguments are more important when adjust the size in a list of
heatmaps (see Section
<a href="a-list-of-heatmaps.html#size-of-heatmaps">4.2</a>).</p>
<p>When the size of the heatmap is set as absolute units, it is possible that the
size of the figure is larger than the size of the plot, which gives blank
areas around the plot. The size of the heatmap can be retrieved by <code>width()</code>
and <code>height()</code> functions.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="a-single-heatmap.html#cb135-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">width =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>), <span class="dt">height =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>))</span>
<span id="cb135-2"><a href="a-single-heatmap.html#cb135-2"></a>ht =<span class="st"> </span><span class="kw">draw</span>(ht)</span>
<span id="cb135-3"><a href="a-single-heatmap.html#cb135-3"></a>ComplexHeatmap<span class="op">:::</span><span class="kw">width</span>(ht)</span></code></pre></div>
<pre><code>## [1] 118.985533333333mm</code></pre>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="a-single-heatmap.html#cb137-1"></a>ComplexHeatmap<span class="op">:::</span><span class="kw">height</span>(ht)</span></code></pre></div>
<pre><code>## [1] 114.8515mm</code></pre>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="a-single-heatmap.html#cb139-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">heatmap_width =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>), </span>
<span id="cb139-2"><a href="a-single-heatmap.html#cb139-2"></a>    <span class="dt">heatmap_height =</span> <span class="kw">unit</span>(<span class="dv">8</span>, <span class="st">&quot;cm&quot;</span>))</span>
<span id="cb139-3"><a href="a-single-heatmap.html#cb139-3"></a>ht =<span class="st"> </span><span class="kw">draw</span>(ht)</span>
<span id="cb139-4"><a href="a-single-heatmap.html#cb139-4"></a>ComplexHeatmap<span class="op">:::</span><span class="kw">width</span>(ht)</span></code></pre></div>
<pre><code>## [1] 95.0216666666667mm</code></pre>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="a-single-heatmap.html#cb141-1"></a>ComplexHeatmap<span class="op">:::</span><span class="kw">height</span>(ht)</span></code></pre></div>
<pre><code>## [1] 84mm</code></pre>
</div>
<div id="plot-the-heatmap" class="section level2" number="2.11">
<h2><span class="header-section-number">2.11</span> Plot the heatmap</h2>
<p><code>Heatmap()</code> function actually is only a constructor, which means it only puts
all the data and configurations into the object in the <code>Heatmap</code> class. The
clustering will only be performed when the <code>draw()</code> method is called. Under
interactive mode (e.g. the interactive R terminal where you can type your R
code line by line), directly calling <code>Heatmap()</code> without returning to any
object prints the object and the print method (or the S4 <code>show()</code> method) for
the <code>Heatmap</code> class object calls <code>draw()</code> internally. So if you type
<code>Heatmap(...)</code> in your R terminal, it looks like it is a plotting function
like <code>plot()</code>, you need to be aware of that it is actually not true and in the
following cases you might see nothing plotted.</p>
<ul>
<li>you put <code>Heatmap(...)</code> inside a function,</li>
<li>you put <code>Heatmap(...)</code> in a code chunk like <code>for</code> or <code>if-else</code></li>
<li>you put <code>Heatmap(...)</code> in an Rscript and you run it under command line.</li>
</ul>
<p>The reason is in above three cases, the <code>show()</code> method WILL NOT be called and
thus <code>draw()</code> method is not executed either. So, to make the plot, you need to
call <code>draw()</code> explicitly: <code>draw(Heatmap(...))</code> or:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="a-single-heatmap.html#cb143-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb143-2"><a href="a-single-heatmap.html#cb143-2"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(...)</span>
<span id="cb143-3"><a href="a-single-heatmap.html#cb143-3"></a><span class="kw">draw</span>(ht)</span></code></pre></div>
<p>The <code>draw()</code> function actually is applied to a list of heatmaps in
<code>HeatmapList</code> class. The <code>draw()</code> method for the single <code>Heatmap</code> class
constructs a <code>HeatmapList</code> with only one heatmap and call <code>draw()</code> method of
the <code>HeatmapList</code> class. The <code>draw()</code> function accpets a lot of more arguments
which e.g. controls the legends. It will be discussed in Chapter
<a href="a-list-of-heatmaps.html#a-list-of-heatmaps">4</a>.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="a-single-heatmap.html#cb144-1"></a><span class="kw">draw</span>(ht, heatmap_legend_side, padding, ...)</span></code></pre></div>
</div>
<div id="get-orders-and-dendrograms-from-heatmap" class="section level2" number="2.12">
<h2><span class="header-section-number">2.12</span> Get orders and dendrograms</h2>
<p>The row/column orders of the heatmap can be obtained by
<code>row_order()</code>/<code>column_order()</code> functions. You can directly apply to the
heatmap object returned by <code>Heatmap()</code> or to the object returned by <code>draw()</code>.
In following, we take <code>row_order()</code> as example.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="a-single-heatmap.html#cb145-1"></a>small_mat =<span class="st"> </span>mat[<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>]</span>
<span id="cb145-2"><a href="a-single-heatmap.html#cb145-2"></a>ht1 =<span class="st"> </span><span class="kw">Heatmap</span>(small_mat)</span>
<span id="cb145-3"><a href="a-single-heatmap.html#cb145-3"></a><span class="kw">row_order</span>(ht1)</span></code></pre></div>
<pre><code>## [1] 5 7 2 4 9 6 8 1 3</code></pre>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="a-single-heatmap.html#cb147-1"></a>ht2 =<span class="st"> </span><span class="kw">draw</span>(ht1)</span>
<span id="cb147-2"><a href="a-single-heatmap.html#cb147-2"></a><span class="kw">row_order</span>(ht2)</span></code></pre></div>
<pre><code>## [1] 5 7 2 4 9 6 8 1 3</code></pre>
<p>As explained in previous section, <code>Heatmap()</code> function does not perform
clustering, thus, when directly apply <code>row_order()</code> on <code>ht1</code>, clustering will
be first performed. Later when making the heatmap by <code>draw(ht1)</code>, the
clustering will be applied again. This might be a problem that if you set
k-means clustering in the heatmap. Since the clustering is applied twice,
k-means might give you different clusterings, which means, you might have
different results from <code>row_order()</code> and you might have different heatmap.</p>
<p>In following chunk of code, <code>o1</code>, <code>o2</code> and <code>o3</code> might be different because
each time, k-means clustering is performed.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="a-single-heatmap.html#cb149-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb149-2"><a href="a-single-heatmap.html#cb149-2"></a>ht1 =<span class="st"> </span><span class="kw">Heatmap</span>(small_mat, <span class="dt">row_km =</span> <span class="dv">2</span>)</span>
<span id="cb149-3"><a href="a-single-heatmap.html#cb149-3"></a>o1 =<span class="st"> </span><span class="kw">row_order</span>(ht1)</span>
<span id="cb149-4"><a href="a-single-heatmap.html#cb149-4"></a>o2 =<span class="st"> </span><span class="kw">row_order</span>(ht1)</span>
<span id="cb149-5"><a href="a-single-heatmap.html#cb149-5"></a>ht2 =<span class="st"> </span><span class="kw">draw</span>(ht1)</span>
<span id="cb149-6"><a href="a-single-heatmap.html#cb149-6"></a>o3 =<span class="st"> </span><span class="kw">row_order</span>(ht2)</span>
<span id="cb149-7"><a href="a-single-heatmap.html#cb149-7"></a>o4 =<span class="st"> </span><span class="kw">row_order</span>(ht2)</span></code></pre></div>
<p><code>draw()</code> function returns the heatmap (or more precisely, the heatmap list)
which has already been reordered, and applying <code>row_order()</code> just extracts the
row order from the object, which ensures the row order is exactly the same as
the one shown in the heatmap. In above code, <code>o3</code> is always identical to <code>o4</code>.</p>
<p>So, the preferable way to get row/column orders is as follows.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="a-single-heatmap.html#cb150-1"></a><span class="co"># code only for demonstration</span></span>
<span id="cb150-2"><a href="a-single-heatmap.html#cb150-2"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(small_mat)</span>
<span id="cb150-3"><a href="a-single-heatmap.html#cb150-3"></a>ht =<span class="st"> </span><span class="kw">draw</span>(ht)</span>
<span id="cb150-4"><a href="a-single-heatmap.html#cb150-4"></a><span class="kw">row_order</span>(ht)</span>
<span id="cb150-5"><a href="a-single-heatmap.html#cb150-5"></a><span class="kw">column_order</span>(ht)</span></code></pre></div>
<p>If rows/columns are split, row order or column order will be a list.</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="a-single-heatmap.html#cb151-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(small_mat, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">3</span>)</span>
<span id="cb151-2"><a href="a-single-heatmap.html#cb151-2"></a>ht =<span class="st"> </span><span class="kw">draw</span>(ht)</span>
<span id="cb151-3"><a href="a-single-heatmap.html#cb151-3"></a><span class="kw">row_order</span>(ht)</span></code></pre></div>
<pre><code>## $`1`
## [1] 9 6 8 1 3
## 
## $`2`
## [1] 5 7 2 4</code></pre>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="a-single-heatmap.html#cb153-1"></a><span class="kw">column_order</span>(ht)</span></code></pre></div>
<pre><code>## $`1`
## [1] 6 2 7
## 
## $`2`
## [1] 8 9
## 
## $`3`
## [1] 1 3 4 5</code></pre>
<p>Similarly, the <code>row_dend()</code>/<code>column_dend()</code> functions return the dendrograms.
It returns a single dendrogram or a list of dendrograms depending on whether
the heatmap is split.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="a-single-heatmap.html#cb155-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(small_mat, <span class="dt">row_km =</span> <span class="dv">2</span>)</span>
<span id="cb155-2"><a href="a-single-heatmap.html#cb155-2"></a>ht =<span class="st"> </span><span class="kw">draw</span>(ht)</span>
<span id="cb155-3"><a href="a-single-heatmap.html#cb155-3"></a><span class="kw">row_dend</span>(ht)</span></code></pre></div>
<pre><code>## $`1`
## &#39;dendrogram&#39; with 2 branches and 5 members total, at height 2.681351 
## 
## $`2`
## &#39;dendrogram&#39; with 2 branches and 4 members total, at height 2.946428</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="a-single-heatmap.html#cb157-1"></a><span class="kw">column_dend</span>(ht)</span></code></pre></div>
<pre><code>## &#39;dendrogram&#39; with 2 branches and 9 members total, at height 4.574114</code></pre>
<p><code>row_order()</code>, <code>column_order()</code>, <code>row_dend()</code> and <code>column_dend()</code> also work
for a list of heatmaps, it will be introduced in Section
<a href="a-list-of-heatmaps.html#get-orders-and-dendrograms-from-a-list-of-heatmaps">4.12</a>.</p>
</div>
<div id="subset-a-heatmap" class="section level2" number="2.13">
<h2><span class="header-section-number">2.13</span> Subset a heatmap</h2>
<p>Since heatmap is a representation of a matrix, there is also a subset method
for the <code>Heatmap</code> class.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="a-single-heatmap.html#cb159-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>)</span>
<span id="cb159-2"><a href="a-single-heatmap.html#cb159-2"></a><span class="kw">dim</span>(ht)</span></code></pre></div>
<pre><code>## [1] 18 24</code></pre>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="a-single-heatmap.html#cb161-1"></a>ht[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-88-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The annotations are subsetted accordingly as well.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="a-single-heatmap.html#cb162-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>, <span class="dt">column_km =</span> <span class="dv">3</span>,</span>
<span id="cb162-2"><a href="a-single-heatmap.html#cb162-2"></a>    <span class="dt">col =</span> <span class="kw">colorRamp2</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="st">&quot;green&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>)),</span>
<span id="cb162-3"><a href="a-single-heatmap.html#cb162-3"></a>    <span class="dt">top_annotation =</span> <span class="kw">HeatmapAnnotation</span>(<span class="dt">foo1 =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>, <span class="dt">bar1 =</span> <span class="kw">anno_points</span>(<span class="kw">runif</span>(<span class="dv">24</span>))),</span>
<span id="cb162-4"><a href="a-single-heatmap.html#cb162-4"></a>    <span class="dt">right_annotation =</span> <span class="kw">rowAnnotation</span>(<span class="dt">foo2 =</span> <span class="dv">18</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">bar2 =</span> <span class="kw">anno_barplot</span>(<span class="kw">runif</span>(<span class="dv">18</span>)))</span>
<span id="cb162-5"><a href="a-single-heatmap.html#cb162-5"></a>)</span>
<span id="cb162-6"><a href="a-single-heatmap.html#cb162-6"></a>ht[<span class="dv">1</span><span class="op">:</span><span class="dv">9</span><span class="op">*</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">12</span><span class="op">*</span><span class="dv">2</span>] <span class="co"># odd rows, even columns</span></span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-89-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The heatmap components are subsetted if they are vector-like. Some
configurations in the heatmap keep the same when subsetting, e.g. if <code>row_km</code>
is set in the original heatmap, the configuration of k-means is kept and it is
performed in the sub-heatmap. So in following example, k-means clustering is
only performed when making heatmap for <code>ht2</code>.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="a-single-heatmap.html#cb163-1"></a>ht =<span class="st"> </span><span class="kw">Heatmap</span>(mat, <span class="dt">name =</span> <span class="st">&quot;mat&quot;</span>, <span class="dt">row_km =</span> <span class="dv">2</span>)</span>
<span id="cb163-2"><a href="a-single-heatmap.html#cb163-2"></a>ht2 =<span class="st"> </span>ht[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]</span>
<span id="cb163-3"><a href="a-single-heatmap.html#cb163-3"></a>ht2</span></code></pre></div>
<p><img src="02-single_heatmap_files/figure-html/unnamed-chunk-90-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><strong>The implementation of subsetting heatmaps is very experimental.</strong> It is not
always working, e.g. if <code>cell_fun</code> is defined and uses an external matrix, or
clustering objects are assigned to <code>cluster_rows</code> or <code>cluster_columns</code>.</p>
<p>There are also subset methods for the <code>HeatmapAnnotation</code> class (Section
<a href="heatmap-annotations.html#heatmap-annotation-utility-function">3.19</a>) and the <code>HeatmapList</code> class (Section <a href="a-list-of-heatmaps.html#subset-heatmap-list">4.10</a>),
but both are very experimental as well.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="heatmap-annotations.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/jokergoo/ComplexHeatmap-reference/edit/master/02-single_heatmap.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["ComplexHeatmap-reference.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
